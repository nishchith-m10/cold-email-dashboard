{
  "project": "cold-email-dashboard",
  "branchName": "ralph/domain4-event-ingestion-cost-tracking",
  "description": "Domain 4: Event Ingestion & Cost Tracking — Security, multi-tenancy, and attribution fixes",
  "userStories": [
    {
      "id": "D4-001",
      "title": "Per-workspace webhook tokens (Critical Security Fix)",
      "description": "Add webhook_token column to workspaces table. Generate per-workspace tokens on creation. Update both event ingestion APIs to validate token against workspace, deriving workspace_id server-side. Keep DASH_WEBHOOK_TOKEN as gated super-admin bypass.",
      "acceptanceCriteria": [
        "Migration adds webhook_token TEXT UNIQUE column to workspaces table",
        "Existing workspaces get generated tokens via UPDATE",
        "createWorkspace() generates webhook_token on new workspace creation",
        "Both /api/events and /api/cost-events validate token against workspaces table",
        "workspace_id derived server-side from token lookup — not trusted from payload",
        "DASH_WEBHOOK_TOKEN works as super-admin bypass when ALLOW_GLOBAL_WEBHOOK_TOKEN=true",
        "401 returned for unknown/mismatched tokens",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-002",
      "title": "Secure cost-events GET endpoint",
      "description": "Add Clerk auth() + validateWorkspaceAccess() to GET /api/cost-events. Return 401 if unauthenticated, 403 if no workspace access.",
      "acceptanceCriteria": [
        "GET /api/cost-events requires Clerk authentication",
        "Workspace access validated via validateWorkspaceAccess()",
        "401 returned for unauthenticated requests",
        "403 returned for unauthorized workspace access",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-003",
      "title": "Remove DEFAULT_WORKSPACE_ID fallback from ingestion",
      "description": "Change workspace_id from optional to required in both event route Zod schemas. Remove DEFAULT_WORKSPACE_ID fallback. Return 400 when workspace_id missing.",
      "acceptanceCriteria": [
        "workspace_id is required in eventSchema and costEventSchema",
        "400 returned when workspace_id is missing",
        "DEFAULT_WORKSPACE_ID import removed from both route files",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-004",
      "title": "Add indexed idempotency_key column to email_events",
      "description": "Migration adding idempotency_key TEXT column + partial unique index. Update event route to write and query the indexed column instead of JSONB metadata extraction.",
      "acceptanceCriteria": [
        "Migration adds idempotency_key TEXT column",
        "Unique index on (workspace_id, idempotency_key) WHERE idempotency_key IS NOT NULL",
        "Event route writes idempotency_key to new column",
        "Idempotency check uses .eq('idempotency_key', key) instead of metadata->> extraction",
        "Backfill UPDATE included in migration",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-005",
      "title": "Automatic budget enforcement in cost-events",
      "description": "Before inserting cost events, check current month spend against plan limit. Reject with 402 if budget exceeded.",
      "acceptanceCriteria": [
        "Pre-insert budget check queries current month SUM(cost_usd)",
        "Events rejected with 402 when budget exceeded",
        "Response includes current_spend and limit",
        "Enterprise plan (unlimited) is never rejected",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-006",
      "title": "Add campaign_group_id to cost tracking path",
      "description": "Add campaign_group_id to costEventSchema, write it to llm_usage INSERT, rebuild v_llm_cost_secure with campaign dimension, update Research Report.json template.",
      "acceptanceCriteria": [
        "costEventSchema accepts campaign_group_id: z.string().uuid().optional()",
        "llm_usage INSERT includes campaign_group_id",
        "v_llm_cost_secure rebuilt with campaign_group_id in SELECT + GROUP BY",
        "base-cold-email/Research Report.json cost event includes campaign_group_id",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-007",
      "title": "Guard against missing contacts/emails tables",
      "description": "Wrap contacts/emails upserts in proper try-catch detecting 'relation does not exist'. Remove (supabaseAdmin as any) type assertions. Add graceful skip logging.",
      "acceptanceCriteria": [
        "contacts/emails upserts wrapped in try-catch",
        "42P01 (relation not found) error handled gracefully",
        "(supabaseAdmin as any) type assertions removed",
        "Console warning logged when tables missing",
        "Event insertion continues even if contact/email tables missing",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "D4-008",
      "title": "Fix n8n template hardcoded WORKSPACE_ID",
      "description": "Update Email 1/2/3 click-tracking code to use YOUR_WORKSPACE_ID placeholder instead of hardcoded 'default'. Update Research Report.json cost event to include workspace_id.",
      "acceptanceCriteria": [
        "Email 1.json click-tracking uses YOUR_WORKSPACE_ID not 'default'",
        "Email 2.json click-tracking uses YOUR_WORKSPACE_ID not 'default'",
        "Email 3.json click-tracking uses YOUR_WORKSPACE_ID not 'default'",
        "Research Report.json cost event includes workspace_id: YOUR_WORKSPACE_ID"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    }
  ]
}
