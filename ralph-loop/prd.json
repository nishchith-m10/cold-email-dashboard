{
  "project": "cold-email-dashboard",
  "branchName": "ralph/domain6-onboarding-wizard",
  "description": "Domain 6: Onboarding Wizard â€” Launch route wiring, IgnitionConfig assembler, DB error handling, workspace auth on credentials, SSRF protection on auto-scrape, encryption key rotation",
  "userStories": [
    {
      "id": "D6-001",
      "title": "Wire onboarding completion to ignition orchestrator",
      "description": "Create POST /api/onboarding/launch route that validates auth, verifies all stages complete, assembles IgnitionConfig via assembler, calls IgnitionOrchestrator.ignite(). Create GET /api/onboarding/ignition-status route that reads from genesis.ignition_state table.",
      "acceptanceCriteria": [
        "POST /api/onboarding/launch exists with Clerk auth + workspace access validation",
        "Route verifies all onboarding stages are complete before launching",
        "Route assembles IgnitionConfig from collected onboarding data via IgnitionConfigAssembler",
        "Route calls IgnitionOrchestrator.ignite() and returns ignition state",
        "GET /api/onboarding/ignition-status returns current ignition state for a workspace",
        "Both routes handle errors gracefully and return appropriate status codes"
      ],
      "passes": true,
      "notes": "Committed at c5d1fc3"
    },
    {
      "id": "D6-002",
      "title": "Create IgnitionConfig assembler service",
      "description": "Create lib/genesis/ignition-config-assembler.ts with IgnitionConfigAssembler class. assemble() collects workspace identity, region/size, credentials (decrypted), variables (brand data), and returns complete IgnitionConfig. validate() checks all required fields.",
      "acceptanceCriteria": [
        "IgnitionConfigAssembler class exists in lib/genesis/ignition-config-assembler.ts",
        "assemble(workspaceId, requestedBy) reads workspace, infrastructure, credentials, and brand data",
        "Credentials are decrypted and converted to CredentialConfig[] format",
        "Variables include YOUR_SENDER_EMAIL from brand/credentials data",
        "validate(config) checks all required fields and returns detailed errors",
        "Returns descriptive errors for missing data"
      ],
      "passes": true,
      "notes": "Committed at cc19997"
    },
    {
      "id": "D6-003",
      "title": "Fix infrastructure and progress endpoints to fail on DB errors",
      "description": "In POST /api/onboarding/infrastructure, change catch block to return { success: false } with 500 instead of { success: true }. Same fix in POST /api/onboarding/progress.",
      "acceptanceCriteria": [
        "POST /api/onboarding/infrastructure returns { success: false, error } with status 500 on DB write failure",
        "POST /api/onboarding/progress returns { success: false, error } with status 500 on DB write failure",
        "GET endpoints still return defaults gracefully on missing tables",
        "Error messages are user-friendly"
      ],
      "passes": true,
      "notes": "Committed at a52d0e1"
    },
    {
      "id": "D6-004",
      "title": "Add workspace access validation to credentials endpoint",
      "description": "In POST and GET /api/onboarding/credentials, after Clerk auth, validate user has access to the workspace via canAccessWorkspace(). Return 403 if no access.",
      "acceptanceCriteria": [
        "POST /api/onboarding/credentials calls canAccessWorkspace(userId, workspaceId)",
        "Returns 403 with Forbidden if user lacks workspace access",
        "GET /api/onboarding/credentials also validates workspace access",
        "Imports canAccessWorkspace from lib/api-workspace-guard"
      ],
      "passes": true,
      "notes": "Committed at 247c9b0"
    },
    {
      "id": "D6-005",
      "title": "Add auth check and SSRF protection to brand auto-scrape",
      "description": "Add Clerk auth check to POST /api/onboarding/brand/auto-scrape. Add SSRF protection: validate URL scheme is http/https only, reject internal IPs.",
      "acceptanceCriteria": [
        "Auto-scrape endpoint requires Clerk auth (returns 401 if not authenticated)",
        "URL scheme validation rejects non-http/https schemes",
        "Internal IP detection blocks 10.x, 192.168.x, 127.x, 169.254.x, 0.0.0.0",
        "Valid public URLs continue to work normally"
      ],
      "passes": true,
      "notes": "Committed at 5c5e2e6"
    },
    {
      "id": "D6-006",
      "title": "Implement encryption key rotation support",
      "description": "Add ENCRYPTION_MASTER_KEY_PREVIOUS env var support to EncryptionService. When decrypt fails with current key, retry with previous key. Add reEncryptAllCredentials() method.",
      "acceptanceCriteria": [
        "EncryptionService accepts optional previousMasterKeyHex parameter",
        "decrypt() tries current key first, falls back to previous key on failure",
        "CredentialVaultService has reEncryptAllCredentials(workspaceId) method",
        "reEncryptAll reads, decrypts with old/current key, re-encrypts with current key",
        "ENCRYPTION_MASTER_KEY_PREVIOUS env var is supported"
      ],
      "passes": true,
      "notes": "Committed at c3737c6"
    }
  ]
}
