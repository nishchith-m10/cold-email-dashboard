{
  "project": "cold-email-dashboard",
  "branchName": "ralph/domain5-rls-multi-tenant-security",
  "description": "Domain 5: RLS & Multi-Tenant Security Posture â€” Tenant-scoped clients, hardened RLS policies, cache invalidation, workspace middleware, super admin audit logging",
  "userStories": [
    {
      "id": "D5-001",
      "title": "Tenant-scoped Supabase client + RLS policy hardening",
      "description": "Create createTenantSupabaseClient() and setTenantContext() in lib/supabase.ts. Harden ALL RLS policies by removing the insecure NULL-fallback pattern. Add RLS to workspaces, user_workspaces, campaigns, notifications. Create set_tenant_context() RPC. Create governance_audit_log table.",
      "acceptanceCriteria": [
        "createTenantSupabaseClient(workspaceId) sets app.current_workspace_id via RPC",
        "setTenantContext(client, workspaceId) calls set_tenant_context RPC",
        "set_tenant_context() SQL function created with SECURITY DEFINER",
        "All existing RLS policies drop NULL-fallback and use strict tenant isolation",
        "Service-role bypass policies added for all tables",
        "RLS enabled on workspaces, user_workspaces, campaigns, notifications",
        "governance_audit_log table created with RLS",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Committed at 6cff3f3"
    },
    {
      "id": "D5-002",
      "title": "Protect materialized views from direct PostgREST access",
      "description": "REVOKE SELECT on mv_daily_stats, mv_llm_cost, v_llm_cost_secure from anon/authenticated. Create secure wrapper views (daily_stats_secure, llm_cost_secure) filtered by tenant context.",
      "acceptanceCriteria": [
        "SELECT revoked on mv_daily_stats from anon and authenticated",
        "SELECT revoked on mv_llm_cost from anon and authenticated",
        "daily_stats_secure view created with workspace_id filter",
        "llm_cost_secure view created with workspace_id filter",
        "Secure views granted to authenticated and service_role"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Committed at 4200a81"
    },
    {
      "id": "D5-003",
      "title": "Cache invalidation on membership changes + TTL reduction",
      "description": "Reduce workspace access cache TTL from 5 minutes to 60 seconds. Add clearAllWorkspaceEntries(workspaceId). Wire cache invalidation into freeze-workspace and members routes.",
      "acceptanceCriteria": [
        "CACHE_TTL_MS reduced to 60 seconds",
        "clearAllWorkspaceEntries(workspaceId) function added",
        "freeze-workspace POST calls clearAllWorkspaceEntries after freeze",
        "freeze-workspace DELETE calls clearAllWorkspaceEntries after unfreeze",
        "Members POST (add) calls clearWorkspaceCache for new user",
        "Members PATCH (role change) calls clearWorkspaceCache for target user",
        "Members DELETE (remove) calls clearWorkspaceCache for removed user"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Committed at 6e1b84a"
    },
    {
      "id": "D5-004",
      "title": "Workspace access middleware (withWorkspaceAuth wrapper)",
      "description": "Create lib/workspace-middleware.ts with withWorkspaceAuth() that extracts workspace_id, validates Clerk auth, validates membership, sets tenant RLS context, and provides WorkspaceContext to handlers.",
      "acceptanceCriteria": [
        "withWorkspaceAuth() wrapper created in lib/workspace-middleware.ts",
        "Extracts workspace_id from query params or headers",
        "Validates Clerk authentication",
        "Validates workspace access via canAccessWorkspace()",
        "Creates tenant-scoped Supabase client with RLS context",
        "Provides WorkspaceContext (userId, workspaceId, role, tenantClient, adminClient)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Committed at a0bd4dc"
    },
    {
      "id": "D5-005",
      "title": "Super admin audit logging",
      "description": "When super admin bypass is used in canAccessWorkspace(), fire-and-forget insert into governance_audit_log with actor_id, action, workspace_id, and endpoint URL.",
      "acceptanceCriteria": [
        "logSuperAdminAccess() function added (fire-and-forget pattern)",
        "canAccessWorkspace() calls logSuperAdminAccess when SUPER_ADMIN_IDS match",
        "canAccessWorkspace() accepts optional requestUrl parameter",
        "validateWorkspaceAccess() passes request.url to canAccessWorkspace()",
        "withWorkspaceAuth() passes req.url to canAccessWorkspace()",
        "Audit log includes actor_id, action='super_admin_access', workspace_id, endpoint metadata",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Committed at 52be2a7"
    }
  ]
}
