{
  "project": "cold-email-dashboard",
  "branchName": "ralph/domain7-sandbox-engine",
  "description": "Domain 7: Sandbox Engine — is_test columns, aggregate query isolation, SSE polling optimization, real EventDB implementation, LOCAL_MODE sidecar fallback",
  "userStories": [
    {
      "id": "D7-001",
      "title": "Add is_test column to email_events and llm_usage",
      "description": "Create migration adding is_test BOOLEAN NOT NULL DEFAULT false to email_events and llm_usage. Add partial indexes on is_test WHERE is_test = true. Update Zod schemas and INSERT logic in events and cost-events API routes.",
      "acceptanceCriteria": [
        "Migration adds is_test column to email_events with default false",
        "Migration adds is_test column to llm_usage with default false",
        "Partial indexes created for efficient filtering",
        "Events API route Zod schema includes optional is_test boolean",
        "Events API route INSERT includes is_test field",
        "Cost-events API route Zod schema includes optional is_test boolean",
        "Cost-events API route INSERT includes is_test field"
      ],
      "passes": true,
      "notes": "Committed at 7f46df7"
    },
    {
      "id": "D7-002",
      "title": "Filter is_test events from dashboard aggregate queries",
      "description": "Add .eq('is_test', false) to buildEventFilters helper and standalone queries (stepBreakdown, llmUsage, clickEvents) in the dashboard aggregate route so sandbox test data never appears in production dashboards.",
      "acceptanceCriteria": [
        "buildEventFilters adds .eq('is_test', false) — covers 8 count queries",
        "stepBreakdownQuery filters is_test=false",
        "llmUsageQuery filters is_test=false",
        "clickEventsQuery filters is_test=false",
        "daily_stats excluded (materialized view, no test data)"
      ],
      "passes": true,
      "notes": "Committed at fd3e095"
    },
    {
      "id": "D7-003",
      "title": "Optimize SSE polling interval",
      "description": "Reduce execution-stream SSE polling from 500ms to 2000ms. Adjust MAX_POLLS from 600 to 150 (maintains 5-min timeout). Adjust heartbeat from every 10 polls to every 5 polls.",
      "acceptanceCriteria": [
        "Poll interval changed from 500ms to 2000ms",
        "MAX_POLLS changed from 600 to 150 (same 5-min timeout)",
        "Heartbeat changed from every 10 polls (5s) to every 5 polls (10s)",
        "4x reduction in DB query volume"
      ],
      "passes": true,
      "notes": "Committed at 72769df"
    },
    {
      "id": "D7-004",
      "title": "Replace mock EventDB stubs with real Supabase implementations",
      "description": "In createEventDB(), replace stub methods (insertEvent, getEventsByExecution, isExecutionComplete, getExecutionWorkspace, getAllEvents, listTestRuns, countRunsInWindow) with real genesis schema queries.",
      "acceptanceCriteria": [
        "insertEvent INSERTs into genesis.workflow_execution_events",
        "getEventsByExecution SELECTs with optional afterId cursor",
        "isExecutionComplete checks for _execution_complete node_type",
        "getExecutionWorkspace returns workspace_id from first event",
        "getAllEvents returns all events ordered by created_at",
        "listTestRuns SELECTs from sandbox_test_runs with limit",
        "countRunsInWindow uses COUNT with timestamp window"
      ],
      "passes": true,
      "notes": "Committed at 777a39c"
    },
    {
      "id": "D7-005",
      "title": "Add LOCAL_MODE fallback for sidecar URL lookup",
      "description": "In createWorkspaceLookupDB().getSidecarUrl(), when partition_registry returns no URL, fall back to LOCAL_SIDECAR_URL or LOCAL_N8N_URL environment variables for local development.",
      "acceptanceCriteria": [
        "getSidecarUrl tries partition_registry first",
        "Falls back to LOCAL_SIDECAR_URL env var if no registry entry",
        "Falls back to LOCAL_N8N_URL env var as secondary fallback",
        "Returns null only if all sources exhausted"
      ],
      "passes": true,
      "notes": "Committed at 2e7bda6"
    }
  ]
}
