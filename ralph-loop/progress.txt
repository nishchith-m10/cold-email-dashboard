# Ralph Progress Log
Started: 2026-02-11
---

## Codebase Patterns
- Recharts 3.x: Use `TooltipContentProps` (not `TooltipProps`) for custom tooltip `content` render functions
- Recharts 3.x: `MouseHandlerDataParam` no longer has `activePayload` — use `activeTooltipIndex` + data lookup
- Recharts 3.x: `DotItemDotProps` has optional `cx/cy` (number | undefined)
- Recharts 3.x: `Formatter<TValue, TName>` now takes `(value: TValue | undefined, ...)`
- Project uses `next lint` and TypeScript strict mode
- Supabase Realtime hooks should use refs for values referenced in subscribe callbacks to avoid re-subscription loops
- Use `subscribeRef` pattern to break circular deps between `subscribe` and `attemptRetry`
- event_ts index migration already exists at `20251205_add_event_ts_index.sql`
- Admin tabs: Component in `components/admin/`, hook in `hooks/`, API routes in `app/api/admin/`. All 3 layers must be wired.
- Phase 44 types export `MetricTrend` (sparkline data), Phase 71 types export `DiagnosticGuide` (service diagnostics)
- useScaleHistory, useAPIHealthHistory, useDisasterRecoveryStats, useRestoreSnapshot existed as hooks but had zero frontend consumers — always check before creating new hooks
- Pure SVG sparklines (no library): polyline with normalized values, 80x24 viewbox works well for inline trend-lines
- Diagnostic endpoint: `/api/admin/api-health/diagnostics/[serviceId]` returns `{ success, guide: DiagnosticGuide | null, metadata }` — null when service is healthy
- Fragment with key: Use `<Fragment key={...}>` not `<>` when multiple sibling elements need a key in .map()
- DiagnosticGuide fields: `{ serviceId, serviceName, issue, severity, impact, diagnosticSteps[], fixPath, estimatedFixTime, preventionTips[] }`
---

## 2026-02-11 - US-001, US-002, US-003
- Fixed all 12 Recharts 3.x type errors across 4 chart components
- Used proper `TooltipContentProps<ValueType, NameType>` from `recharts/types/component/Tooltip`
- Used function form for `content` prop: `content={(props: TooltipContentProps<ValueType, NameType>) => ...}`
- Fixed `activePayload` → `activeTooltipIndex` for chart onClick in daily-sends-chart
- Fixed dot render prop to handle optional cx/cy via `DotItemDotProps` casting in daily-cost-chart
- Files changed: daily-sends-chart.tsx, daily-cost-chart.tsx, donut-chart.tsx, time-series-chart.tsx
- **Learnings:**
  - Recharts 3.x splits types: `TooltipProps` (component config) vs `TooltipContentProps` (content fn args)
  - `PropertiesReadFromContext` = `viewBox | active | payload | coordinate | label | accessibilityLayer`
  - Never simplify complex generics — use `ValueType, NameType` from recharts DefaultTooltipContent
  - JSX element form of content causes widening; function form preserves generic specificity
---

## 2026-02-11 - US-004
- Fixed realtime-health infinite re-subscription loop
- Root cause: `subscribe` depended on `health.workflowId` and `health.version` state → state update → subscribe recreated → useEffect re-run → teardown/reconnect cycle
- Fix: Added `healthRef` to read state without closure dependency, `subscribeRef` to break circular dep with `attemptRetry`
- Files changed: lib/realtime-health.ts
- **Learnings:**
  - Use refs for state values read inside Supabase Realtime callbacks
  - Use `subscribeRef` pattern when subscribe and retry have circular deps
---

## 2026-02-11 - US-005
- Increased fetcher REQUEST_TIMEOUT from 15s to 30s
- Root cause: /api/dashboard/aggregate runs 15 parallel Supabase queries, 15s too short for cold starts
- Files changed: lib/fetcher.ts
---

## 2026-02-11 - US-006
- event_ts index already exists (20251205_add_event_ts_index.sql + schema.sql line 85)
- No action needed
---

## 2026-02-20 - T3-001 (Wire useScaleHistory sparklines)
- Added `useScaleHistory(30)` call to `ScaleHealthTab`
- Created pure SVG `Sparkline` component (polyline, 80x24 viewbox, auto-normalized values)
- Created `TrendIndicator` component showing metric name, change %, direction arrow, and sparkline
- Latency metrics: "up" = bad (red), "down" = good (green). Other metrics: inverted.
- Renders in responsive grid (1-2-3 cols) between metrics table and active alerts
- Files changed: components/admin/scale-health-tab.tsx (+78 lines)
- **Learnings:**
  - MetricTrend.dataPoints can have null values — filter them before plotting
  - Sparkline color should reflect "good/bad" semantically, not just direction
---

## 2026-02-20 - T3-002 (Wire useAPIHealthHistory 7-day trends)
- Added `useAPIHealthHistory(7)` call to `APIHealthTab`
- Created collapsible "7-Day History" section with toggle button
- Mobile: card layout per snapshot. Desktop: 6-column table.
- Shows timestamp, overall status badge, error/degraded counts, latency, slowest service
- Hidden when no snapshots exist
- Files changed: components/admin/api-health-tab.tsx (+102 lines)
- **Learnings:**
  - Snapshot uses snake_case fields (overall_status, error_count) — matches API response shape
  - Collapsible pattern: button with ChevronDown/Up toggles `showHistory` state
---

## 2026-02-20 - T3-003 (Add Diagnostics button to API Health services table)
- Added "Diagnose" button per service (hidden when status === 'ok')
- Fetches `/api/admin/api-health/diagnostics/{serviceId}` on click
- Created `DiagnosticPanel` component: issue, severity badge, impact, numbered steps, fix path, est. fix time, prevention tips
- Handles cached results (only fetches once per service, then toggles visibility)
- Both mobile card and desktop table layouts updated
- Desktop: uses `<Fragment key={...}>` to wrap `<tr>` + diagnostic `<tr>` pairs
- Files changed: components/admin/api-health-services-table.tsx (+216 lines)
- **Learnings:**
  - DiagnosticGuide can be null when service is healthy — use non-null assertion after truthiness check
  - `React.Fragment` with key prop needed when mapping produces multiple sibling table rows
  - DiagnosticStep.automated boolean adds nice "Automated" badge for auto-fixable steps
---

## 2026-02-20 - T3-004 (Wire useDisasterRecoveryStats into DR tab)
- Added `useDisasterRecoveryStats()` call to `DisasterRecoveryTab`
- Replaced manual coverage calculation with API stats (graceful fallback to manual calc if stats loading)
- Added 4-stat grid below coverage: Total Snapshots, Total Size (GB), Monthly Cost ($), Workspaces
- DollarSign icon for cost display
- Files changed: components/admin/disaster-recovery-tab.tsx (+47 lines)
- **Learnings:**
  - Use nullish coalescing `stats?.coverage ?? fallback()` for graceful API-to-manual fallback
  - DisasterRecoveryStats has all needed fields: totalSnapshots, totalSizeGb, estimatedMonthlyCost, totalWorkspaces
---

## 2026-02-20 - T3-005 (Add Restore from Snapshot button in DR tab)
- Added `useRestoreSnapshot()` hook to `DisasterRecoveryTab`
- Added RotateCcw icon import for Restore button
- Each completed snapshot gets a "Restore" button next to Delete
- Uses `prompt()` for target region input + confirm dialog before restore
- Success/error toast feedback, loading state during restore
- Responsive: text hidden on mobile, shown on sm+
- Files changed: components/admin/disaster-recovery-tab.tsx (+58 lines)
- **Learnings:**
  - useRestoreSnapshot params: { snapshotId, targetRegion } — both strings
  - Only show Restore for `snapshot.status === 'completed'` — failed/pending snapshots can't be restored
---

## 2026-02-26 - Domain 1: Ignition Infrastructure (D1-001 → D1-008)
- Branch: `ralph/domain1-ignition-infrastructure`
- All 8 stories implemented, typechecked (0 errors), committed
- **D1-001** (82b05be): DB migration — genesis.ignition_state + genesis.ignition_operations tables, RLS, indexes, trigger
- **D1-002** (cd1ca8b): SupabaseIgnitionStateDB — production IgnitionStateDB impl, genesis schema access
- **D1-003** (75edd4c): SupabasePartitionManager — delegates to fn_ignite/fn_drop_workspace_partition RPCs
- **D1-004** (7393cc4): HttpSidecarClient — RS256 JWT-signed commands with exponential-backoff retry
- **D1-005** (e133919): Health-check handshake — polls /health every 5s, timeout 5min (30s local)
- **D1-006** (e84539f): Idempotency guard — prevents double-provisioning at ignite() entry
- **D1-007** (7156105): Real workflow rollback — deactivate+delete via sidecar instead of counter stub
- **D1-008** (cd6bf6e): Per-credential retry — retryTransient() with 2s/4s backoff, transient vs permanent
- **Learnings:**
  - `(getTypedSupabaseAdmin() as any).schema('genesis')` pattern for genesis tables outside Database type
  - `get_errors` tool is more reliable than `npx tsc --noEmit` terminal for this project
  - SidecarCommandBuilder handles JWT signing; always use it (don't roll custom JWT)
  - Rollback needs dropletIp param — state has it but CreatedResources doesn't
---

## 2026-02-26 - Domain 2: DEFAULT_TEMPLATES & Workflow Deployer (D2-001 → D2-005)
- Branch: `ralph/domain2-templates-workflow-deployer`
- All 5 stories implemented, typechecked (0 new errors), committed
- **D2-001** (163f609): Gate Sidecar DEPLOY_CAMPAIGN_WORKFLOWS behind SIDECAR_AUTO_DEPLOY env var; deprecation notice
- **D2-002** (8cf0465): required_credentials validation — credTypeToN8nId map + 3-condition check per template
- **D2-003** (8be3034): Unresolved placeholder scan — YOUR_CREDENTIAL_* hard error, content placeholders warn
- **D2-004** (eb3f82f): Sidecar deployer returns all 7 templates (3 email + 4 support)
- **D2-005** (36df5a4): Empty credential placeholder values throw instead of silent skip
- **Files modified:**
  - `sidecar/sidecar-agent.ts` — D2-001 (auto-deploy gate)
  - `sidecar/workflow-deployer.ts` — D2-001 (deprecation), D2-004 (7 templates), D2-005 (empty cred throw)
  - `lib/genesis/ignition-orchestrator.ts` — D2-002 (cred validation), D2-003 (placeholder scan)
- **Learnings:**
  - `npx tsc --noEmit` OOMs on default heap — use `NODE_OPTIONS="--max-old-space-size=4096"`
  - Pre-existing 9 TS errors (test files + step_progress type) — none from Domain 2
  - Sidecar has its own tsconfig; typecheck separately with `cd sidecar && npx tsc --noEmit`
---

## Domain 3 — Campaign Isolation & Data Partitioning (branch: ralph/domain3-campaign-isolation-partitioning)
- All 4 stories implemented, typechecked (0 new errors), committed
- **D3-001** (07e795d): Per-campaign workflow deployer — `deployForCampaign()` in `lib/genesis/campaign-workflow-deployer.ts`, wired into `POST /api/campaigns/provision`
- **D3-002** (2bebbc7): `campaign_group_id` UUID column on `email_events` + partial index + event ingestion updated
- **D3-003** (0ff9a12): 4 composite indexes — (ws,type,ts), (ws,campaign), daily_stats(ws,day), llm_usage(ws,created_at)
- **D3-004** (f33998e): Campaign dropdown from `campaigns` table (source of truth) with fallback to stats-derived list
- **Files created:**
  - `lib/genesis/campaign-workflow-deployer.ts` — D3-001
  - `supabase/migrations/20260301_domain3_campaign_group_id.sql` — D3-002
  - `supabase/migrations/20260301_domain3_composite_indexes.sql` — D3-003
- **Files modified:**
  - `app/api/campaigns/provision/route.ts` — D3-001 (workflow deploy on provision)
  - `app/api/events/route.ts` — D3-002 (campaign_group_id in schema + insert)
  - `app/api/dashboard/aggregate/route.ts` — D3-004 (campaignsListQuery + fallback)
- **Learnings:**
  - Partition registry droplet_ip is the deployment target for per-campaign workflow pushes
  - email_events lacked campaign_group_id — aggregate route's `.eq('campaign_group_id', ...)` would silently return zero results
  - Campaign dropdown from events shows phantom/renamed campaigns; campaigns table is the source of truth
---
