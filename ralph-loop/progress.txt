# Ralph Progress Log
Started: 2026-02-11
---

## Codebase Patterns
- Recharts 3.x: Use `TooltipContentProps` (not `TooltipProps`) for custom tooltip `content` render functions
- Recharts 3.x: `MouseHandlerDataParam` no longer has `activePayload` — use `activeTooltipIndex` + data lookup
- Recharts 3.x: `DotItemDotProps` has optional `cx/cy` (number | undefined)
- Recharts 3.x: `Formatter<TValue, TName>` now takes `(value: TValue | undefined, ...)`
- Project uses `next lint` and TypeScript strict mode
- Supabase Realtime hooks should use refs for values referenced in subscribe callbacks to avoid re-subscription loops
- Use `subscribeRef` pattern to break circular deps between `subscribe` and `attemptRetry`
- event_ts index migration already exists at `20251205_add_event_ts_index.sql`
- Admin tabs: Component in `components/admin/`, hook in `hooks/`, API routes in `app/api/admin/`. All 3 layers must be wired.
- Phase 44 types export `MetricTrend` (sparkline data), Phase 71 types export `DiagnosticGuide` (service diagnostics)
- useScaleHistory, useAPIHealthHistory, useDisasterRecoveryStats, useRestoreSnapshot existed as hooks but had zero frontend consumers — always check before creating new hooks
- Pure SVG sparklines (no library): polyline with normalized values, 80x24 viewbox works well for inline trend-lines
- Diagnostic endpoint: `/api/admin/api-health/diagnostics/[serviceId]` returns `{ success, guide: DiagnosticGuide | null, metadata }` — null when service is healthy
- Fragment with key: Use `<Fragment key={...}>` not `<>` when multiple sibling elements need a key in .map()
- DiagnosticGuide fields: `{ serviceId, serviceName, issue, severity, impact, diagnosticSteps[], fixPath, estimatedFixTime, preventionTips[] }`
---

## 2026-02-11 - US-001, US-002, US-003
- Fixed all 12 Recharts 3.x type errors across 4 chart components
- Used proper `TooltipContentProps<ValueType, NameType>` from `recharts/types/component/Tooltip`
- Used function form for `content` prop: `content={(props: TooltipContentProps<ValueType, NameType>) => ...}`
- Fixed `activePayload` → `activeTooltipIndex` for chart onClick in daily-sends-chart
- Fixed dot render prop to handle optional cx/cy via `DotItemDotProps` casting in daily-cost-chart
- Files changed: daily-sends-chart.tsx, daily-cost-chart.tsx, donut-chart.tsx, time-series-chart.tsx
- **Learnings:**
  - Recharts 3.x splits types: `TooltipProps` (component config) vs `TooltipContentProps` (content fn args)
  - `PropertiesReadFromContext` = `viewBox | active | payload | coordinate | label | accessibilityLayer`
  - Never simplify complex generics — use `ValueType, NameType` from recharts DefaultTooltipContent
  - JSX element form of content causes widening; function form preserves generic specificity
---

## 2026-02-11 - US-004
- Fixed realtime-health infinite re-subscription loop
- Root cause: `subscribe` depended on `health.workflowId` and `health.version` state → state update → subscribe recreated → useEffect re-run → teardown/reconnect cycle
- Fix: Added `healthRef` to read state without closure dependency, `subscribeRef` to break circular dep with `attemptRetry`
- Files changed: lib/realtime-health.ts
- **Learnings:**
  - Use refs for state values read inside Supabase Realtime callbacks
  - Use `subscribeRef` pattern when subscribe and retry have circular deps
---

## 2026-02-11 - US-005
- Increased fetcher REQUEST_TIMEOUT from 15s to 30s
- Root cause: /api/dashboard/aggregate runs 15 parallel Supabase queries, 15s too short for cold starts
- Files changed: lib/fetcher.ts
---

## 2026-02-11 - US-006
- event_ts index already exists (20251205_add_event_ts_index.sql + schema.sql line 85)
- No action needed
---

## 2026-02-20 - T3-001 (Wire useScaleHistory sparklines)
- Added `useScaleHistory(30)` call to `ScaleHealthTab`
- Created pure SVG `Sparkline` component (polyline, 80x24 viewbox, auto-normalized values)
- Created `TrendIndicator` component showing metric name, change %, direction arrow, and sparkline
- Latency metrics: "up" = bad (red), "down" = good (green). Other metrics: inverted.
- Renders in responsive grid (1-2-3 cols) between metrics table and active alerts
- Files changed: components/admin/scale-health-tab.tsx (+78 lines)
- **Learnings:**
  - MetricTrend.dataPoints can have null values — filter them before plotting
  - Sparkline color should reflect "good/bad" semantically, not just direction
---

## 2026-02-20 - T3-002 (Wire useAPIHealthHistory 7-day trends)
- Added `useAPIHealthHistory(7)` call to `APIHealthTab`
- Created collapsible "7-Day History" section with toggle button
- Mobile: card layout per snapshot. Desktop: 6-column table.
- Shows timestamp, overall status badge, error/degraded counts, latency, slowest service
- Hidden when no snapshots exist
- Files changed: components/admin/api-health-tab.tsx (+102 lines)
- **Learnings:**
  - Snapshot uses snake_case fields (overall_status, error_count) — matches API response shape
  - Collapsible pattern: button with ChevronDown/Up toggles `showHistory` state
---

## 2026-02-20 - T3-003 (Add Diagnostics button to API Health services table)
- Added "Diagnose" button per service (hidden when status === 'ok')
- Fetches `/api/admin/api-health/diagnostics/{serviceId}` on click
- Created `DiagnosticPanel` component: issue, severity badge, impact, numbered steps, fix path, est. fix time, prevention tips
- Handles cached results (only fetches once per service, then toggles visibility)
- Both mobile card and desktop table layouts updated
- Desktop: uses `<Fragment key={...}>` to wrap `<tr>` + diagnostic `<tr>` pairs
- Files changed: components/admin/api-health-services-table.tsx (+216 lines)
- **Learnings:**
  - DiagnosticGuide can be null when service is healthy — use non-null assertion after truthiness check
  - `React.Fragment` with key prop needed when mapping produces multiple sibling table rows
  - DiagnosticStep.automated boolean adds nice "Automated" badge for auto-fixable steps
---

## 2026-02-20 - T3-004 (Wire useDisasterRecoveryStats into DR tab)
- Added `useDisasterRecoveryStats()` call to `DisasterRecoveryTab`
- Replaced manual coverage calculation with API stats (graceful fallback to manual calc if stats loading)
- Added 4-stat grid below coverage: Total Snapshots, Total Size (GB), Monthly Cost ($), Workspaces
- DollarSign icon for cost display
- Files changed: components/admin/disaster-recovery-tab.tsx (+47 lines)
- **Learnings:**
  - Use nullish coalescing `stats?.coverage ?? fallback()` for graceful API-to-manual fallback
  - DisasterRecoveryStats has all needed fields: totalSnapshots, totalSizeGb, estimatedMonthlyCost, totalWorkspaces
---

## 2026-02-20 - T3-005 (Add Restore from Snapshot button in DR tab)
- Added `useRestoreSnapshot()` hook to `DisasterRecoveryTab`
- Added RotateCcw icon import for Restore button
- Each completed snapshot gets a "Restore" button next to Delete
- Uses `prompt()` for target region input + confirm dialog before restore
- Success/error toast feedback, loading state during restore
- Responsive: text hidden on mobile, shown on sm+
- Files changed: components/admin/disaster-recovery-tab.tsx (+58 lines)
- **Learnings:**
  - useRestoreSnapshot params: { snapshotId, targetRegion } — both strings
  - Only show Restore for `snapshot.status === 'completed'` — failed/pending snapshots can't be restored
---

## 2026-02-26 - Domain 1: Ignition Infrastructure (D1-001 → D1-008)
- Branch: `ralph/domain1-ignition-infrastructure`
- All 8 stories implemented, typechecked (0 errors), committed
- **D1-001** (82b05be): DB migration — genesis.ignition_state + genesis.ignition_operations tables, RLS, indexes, trigger
- **D1-002** (cd1ca8b): SupabaseIgnitionStateDB — production IgnitionStateDB impl, genesis schema access
- **D1-003** (75edd4c): SupabasePartitionManager — delegates to fn_ignite/fn_drop_workspace_partition RPCs
- **D1-004** (7393cc4): HttpSidecarClient — RS256 JWT-signed commands with exponential-backoff retry
- **D1-005** (e133919): Health-check handshake — polls /health every 5s, timeout 5min (30s local)
- **D1-006** (e84539f): Idempotency guard — prevents double-provisioning at ignite() entry
- **D1-007** (7156105): Real workflow rollback — deactivate+delete via sidecar instead of counter stub
- **D1-008** (cd6bf6e): Per-credential retry — retryTransient() with 2s/4s backoff, transient vs permanent
- **Learnings:**
  - `(getTypedSupabaseAdmin() as any).schema('genesis')` pattern for genesis tables outside Database type
  - `get_errors` tool is more reliable than `npx tsc --noEmit` terminal for this project
  - SidecarCommandBuilder handles JWT signing; always use it (don't roll custom JWT)
  - Rollback needs dropletIp param — state has it but CreatedResources doesn't
---

## 2026-02-26 - Domain 2: DEFAULT_TEMPLATES & Workflow Deployer (D2-001 → D2-005)
- Branch: `ralph/domain2-templates-workflow-deployer`
- All 5 stories implemented, typechecked (0 new errors), committed
- **D2-001** (163f609): Gate Sidecar DEPLOY_CAMPAIGN_WORKFLOWS behind SIDECAR_AUTO_DEPLOY env var; deprecation notice
- **D2-002** (8cf0465): required_credentials validation — credTypeToN8nId map + 3-condition check per template
- **D2-003** (8be3034): Unresolved placeholder scan — YOUR_CREDENTIAL_* hard error, content placeholders warn
- **D2-004** (eb3f82f): Sidecar deployer returns all 7 templates (3 email + 4 support)
- **D2-005** (36df5a4): Empty credential placeholder values throw instead of silent skip
- **Files modified:**
  - `sidecar/sidecar-agent.ts` — D2-001 (auto-deploy gate)
  - `sidecar/workflow-deployer.ts` — D2-001 (deprecation), D2-004 (7 templates), D2-005 (empty cred throw)
  - `lib/genesis/ignition-orchestrator.ts` — D2-002 (cred validation), D2-003 (placeholder scan)
- **Learnings:**
  - `npx tsc --noEmit` OOMs on default heap — use `NODE_OPTIONS="--max-old-space-size=4096"`
  - Pre-existing 9 TS errors (test files + step_progress type) — none from Domain 2
  - Sidecar has its own tsconfig; typecheck separately with `cd sidecar && npx tsc --noEmit`
---

## Domain 3 — Campaign Isolation & Data Partitioning (branch: ralph/domain3-campaign-isolation-partitioning)
- All 4 stories implemented, typechecked (0 new errors), committed
- **D3-001** (07e795d): Per-campaign workflow deployer — `deployForCampaign()` in `lib/genesis/campaign-workflow-deployer.ts`, wired into `POST /api/campaigns/provision`
- **D3-002** (2bebbc7): `campaign_group_id` UUID column on `email_events` + partial index + event ingestion updated
- **D3-003** (0ff9a12): 4 composite indexes — (ws,type,ts), (ws,campaign), daily_stats(ws,day), llm_usage(ws,created_at)
- **D3-004** (f33998e): Campaign dropdown from `campaigns` table (source of truth) with fallback to stats-derived list
- **Files created:**
  - `lib/genesis/campaign-workflow-deployer.ts` — D3-001
  - `supabase/migrations/20260301_domain3_campaign_group_id.sql` — D3-002
  - `supabase/migrations/20260301_domain3_composite_indexes.sql` — D3-003
- **Files modified:**
  - `app/api/campaigns/provision/route.ts` — D3-001 (workflow deploy on provision)
  - `app/api/events/route.ts` — D3-002 (campaign_group_id in schema + insert)
  - `app/api/dashboard/aggregate/route.ts` — D3-004 (campaignsListQuery + fallback)
- **Learnings:**
  - Partition registry droplet_ip is the deployment target for per-campaign workflow pushes
  - email_events lacked campaign_group_id — aggregate route's `.eq('campaign_group_id', ...)` would silently return zero results
  - Campaign dropdown from events shows phantom/renamed campaigns; campaigns table is the source of truth
---
## Domain 4 — Event Ingestion & Cost Tracking (2026-03-01)
- **Branch:** `ralph/domain4-event-ingestion-cost-tracking`
- **D4-001** (6f45736): Per-workspace webhook tokens — migration, resolveWebhookAuth(), routes updated, ignition + campaign deployer
- **D4-002** (in D4-001): GET /api/cost-events secured with Clerk auth + validateWorkspaceAccess
- **D4-003** (in D4-001): DEFAULT_WORKSPACE_ID removed from both routes — workspace_id derived from token
- **D4-004** (7289dcb): Indexed idempotency_key column replaces slow metadata->> JSONB extraction
- **D4-006→005** (a565a1f): campaign_group_id added to cost-events Zod + INSERT + v_llm_cost_secure rebuilt
- **D4-005** (88b35b9): Pre-insert budget enforcement — 402 rejection when plan limit exceeded
- **D4-007** (717460b): contacts/emails upserts guarded with try-catch, (as any) removed
- **D4-008** (60f8b82): n8n templates — WORKSPACE_ID='default'→'YOUR_WORKSPACE_ID', Research Report cost events gain workspace_id + campaign_group_id
- **Files created:**
  - `lib/webhook-auth.ts` — shared resolveWebhookAuth(), 3-tier strategy
  - `supabase/migrations/20260301_domain4_webhook_tokens.sql` — webhook_token column
  - `supabase/migrations/20260301_domain4_idempotency_key.sql` — idempotency_key column
  - `supabase/migrations/20260301_domain4_cost_view_campaign_group.sql` — rebuild v_llm_cost_secure
- **Files modified:**
  - `app/api/events/route.ts` — D4-001 (auth), D4-004 (idempotency), D4-007 (type safety)
  - `app/api/cost-events/route.ts` — D4-001 (auth), D4-005 (budget), D4-006 (campaign_group_id)
  - `lib/genesis/ignition-orchestrator.ts` — D4-001 (per-workspace token in variable map)
  - `lib/genesis/campaign-workflow-deployer.ts` — D4-001 (query workspace webhook_token)
  - `lib/genesis/ignition-types.ts` — D4-001 (webhook_token field)
  - `base-cold-email/Email 1,2,3.json` + SMTP variants — D4-008
  - `base-cold-email/Research Report.json` — D4-008
  - `cold-email-system/Email 1,2,3.json` + Research Report — D4-008
- **Learnings:**
  - Per-workspace token lookup eliminates trust-the-client workspace_id problem entirely
  - Global DASH_WEBHOOK_TOKEN kept as gated fallback (ALLOW_GLOBAL_WEBHOOK_TOKEN env var) for migration period
  - DB DEFAULT `encode(gen_random_bytes(32), 'hex')` auto-generates tokens on workspace creation — no app-level crypto needed
  - llm_usage.campaign_group_id column existed but was always NULL — only needed ingestion + view updates
  - contacts/emails tables ARE properly typed in Supabase schema — (as any) casts were unnecessary
---

## Domain 5: RLS & Multi-Tenant Security Posture
Branch: `ralph/domain5-rls-multi-tenant-security`
- **D5-001** (6cff3f3): Tenant-scoped Supabase client + RLS policy hardening
  - createTenantSupabaseClient() + setTenantContext() in lib/supabase.ts
  - set_tenant_context() SQL RPC (SECURITY DEFINER)
  - Hardened ALL RLS policies: removed insecure NULL-fallback pattern
  - Added RLS to workspaces, user_workspaces, campaigns, notifications
  - Created governance_audit_log table with RLS
  - Service-role bypass policies on all tables
- **D5-002** (4200a81): Protect materialized views from direct PostgREST access
  - REVOKE SELECT on mv_daily_stats, mv_llm_cost from anon/authenticated
  - Created daily_stats_secure + llm_cost_secure wrapper views with tenant filter
- **D5-003** (6e1b84a): Cache invalidation on membership changes + TTL reduction
  - CACHE_TTL_MS reduced from 5 min to 60 seconds
  - clearAllWorkspaceEntries(workspaceId) added for workspace-wide cache bust
  - Freeze/unfreeze routes call clearAllWorkspaceEntries()
  - Member add/remove/role-change routes call clearWorkspaceCache()
- **D5-004** (a0bd4dc): withWorkspaceAuth() middleware wrapper
  - lib/workspace-middleware.ts: composable route wrapper
  - Extracts workspace_id, validates Clerk + membership, sets RLS tenant context
  - Provides WorkspaceContext (userId, workspaceId, role, tenantClient, adminClient)
- **D5-005** (52be2a7): Super admin audit logging
  - logSuperAdminAccess() fire-and-forget insert to governance_audit_log
  - canAccessWorkspace() + validateWorkspaceAccess() + withWorkspaceAuth() pass request URL
- **Files created:**
  - `lib/workspace-middleware.ts` — withWorkspaceAuth() composable wrapper
  - `supabase/migrations/20260301_domain5_rls_hardening.sql` — RLS overhaul
  - `supabase/migrations/20260301_domain5_protect_materialized_views.sql` — MV protection
- **Files modified:**
  - `lib/supabase.ts` — createTenantSupabaseClient, setTenantContext, supabaseAnonKey
  - `lib/api-workspace-guard.ts` — TTL reduction, clearAllWorkspaceEntries, super admin audit
  - `app/api/admin/freeze-workspace/route.ts` — cache invalidation on freeze/unfreeze
  - `app/api/workspaces/[workspaceId]/members/route.ts` — cache invalidation on membership changes
- **Learnings:**
  - Old RLS policies had `OR current_setting(...) IS NULL` — made RLS a no-op when no context set
  - PostgreSQL materialized views cannot have RLS — must use REVOKE + wrapper views
  - Session variable transitioned from app.workspace_id to app.current_workspace_id
  - Fire-and-forget pattern uses .then() on Supabase promise chain (no await) for non-blocking audit
---

## Domain 6: Onboarding Wizard (2026-03-01)
Branch: `ralph/domain6-onboarding-wizard`
- **D6-001** (c5d1fc3): Launch route + ignition-status route
  - POST /api/onboarding/launch — Clerk auth, workspace access, assemble config, ignite
  - GET /api/onboarding/ignition-status — polls SupabaseIgnitionStateDB for provisioning state
  - Uses real SupabaseIgnitionStateDB (0 args) + SupabasePartitionManager (0 args) + mock sidecar/deployer
- **D6-002** (cc19997): IgnitionConfig assembler service
  - lib/genesis/ignition-config-assembler.ts (361 lines)
  - assemble(workspaceId, requestedBy) reads workspace, infrastructure, credentials, brand data
  - Credentials decrypted via CredentialVaultService, mapped to CredentialConfig[] via VAULT_TO_IGNITION_TYPE
  - validate() checks workspace_id, slug, name, region, size, requested_by, YOUR_SENDER_EMAIL, credentials
- **D6-003** (a52d0e1): Fix infrastructure and progress DB error handling
  - POST handlers now return { success: false, error } with 500 on DB write failure
  - Previously returned { success: true } on catch — silent data loss
- **D6-004** (247c9b0): Workspace access validation on credentials endpoint
  - GET + POST /api/onboarding/credentials now call canAccessWorkspace()
  - Returns 403 on unauthorized workspace access
- **D6-005** (5c5e2e6): Auth check + SSRF protection on auto-scrape
  - Added Clerk auth → 401 if unauthenticated
  - isSafeUrl() blocks internal IPs (127.x, 10.x, 192.168.x, 172.16-31.x, 169.254.x, 0.0.0.0, localhost, ::1)
  - Only http/https schemes allowed
- **D6-006** (c3737c6): Encryption key rotation support
  - EncryptionService accepts optional previousMasterKeyHex (or ENCRYPTION_MASTER_KEY_PREVIOUS env var)
  - decrypt() tries current key first, falls back to previous key
  - reEncryptAllCredentials(workspaceId) on CredentialVaultService — reads, decrypts, re-encrypts all rows
- **Files created:**
  - `lib/genesis/ignition-config-assembler.ts` — IgnitionConfig assembler
  - `app/api/onboarding/launch/route.ts` — launch endpoint
  - `app/api/onboarding/ignition-status/route.ts` — status polling endpoint
- **Files modified:**
  - `app/api/onboarding/infrastructure/route.ts` — DB error handling fix
  - `app/api/onboarding/progress/route.ts` — DB error handling fix
  - `app/api/onboarding/credentials/route.ts` — workspace access validation
  - `app/api/onboarding/brand/auto-scrape/route.ts` — auth + SSRF protection
  - `lib/genesis/phase64/credential-vault-service.ts` — key rotation support (+117 lines)
- **Learnings:**
  - SupabaseIgnitionStateDB and SupabasePartitionManager take 0 constructor args — they call getTypedSupabaseAdmin() internally
  - HttpSidecarClient takes {workspaceId, dropletId, privateKey} — not {apiKey}
  - CredentialVault DB adapter needs (as any) casts for genesis schema tables not in auto-generated types
  - SSRF protection must check resolved IP, not hostname — but DNS rebinding prevention is beyond scope for MVP

## Domain 7 — Sandbox Engine (5 stories)
- **Branch:** ralph/domain7-sandbox-engine
- **D7-001** (7f46df7): Added `is_test BOOLEAN NOT NULL DEFAULT false` to email_events and llm_usage via migration. Partial indexes on `is_test WHERE is_test = true`. Updated Zod schemas and INSERT logic in events + cost-events routes.
- **D7-002** (fd3e095): Added `.eq('is_test', false)` to `buildEventFilters` helper (covers 8 count queries) and standalone queries (stepBreakdown, llmUsage, clickEvents) in dashboard aggregate route.
- **D7-003** (72769df): Optimized SSE polling: 500ms → 2000ms interval, MAX_POLLS 600 → 150, heartbeat every 10 → every 5 polls. 4x reduction in DB queries.
- **D7-004** (777a39c): Replaced all mock EventDB stubs with real genesis schema queries (insertEvent, getEventsByExecution, isExecutionComplete, getExecutionWorkspace, getAllEvents, listTestRuns, countRunsInWindow).
- **D7-005** (2e7bda6): Added LOCAL_MODE fallback to createWorkspaceLookupDB — falls back to LOCAL_SIDECAR_URL or LOCAL_N8N_URL env vars when partition_registry has no entry.
- **Files created:**
  - `supabase/migrations/20260301_domain7_is_test_columns.sql` — is_test column migration
- **Files modified:**
  - `app/api/events/route.ts` — Zod schema + INSERT for is_test
  - `app/api/cost-events/route.ts` — Zod schema + INSERT for is_test
  - `app/api/dashboard/aggregate/route.ts` — is_test=false filter on all production queries
  - `app/api/sandbox/execution-stream/[executionId]/route.ts` — SSE polling optimization
  - `app/api/sandbox/test-campaign/route.ts` — real EventDB impl + LOCAL_MODE fallback
- **Learnings:**
  - genesis.sandbox_test_runs and genesis.workflow_execution_events already existed in migration 20260208130001
  - buildEventFilters helper centralizes filter logic for 8 count queries — single point of change
  - daily_stats is a materialized view — doesn't need is_test filter since test data never enters it
  - (supabaseAdmin as any).schema('genesis') pattern required for genesis tables not in auto-generated types
---

## 2026-02-12 - D8-001
- Added frozen workspace check to canAccessWorkspace() in api-workspace-guard.ts
- CacheEntry now includes workspaceStatus field (cached with 60s TTL)
- If workspace.status === 'frozen', returns { hasAccess: false, frozen: true }
- Super admins bypass frozen check
- validateWorkspaceAccess() returns 403 with 'Workspace is frozen' for frozen workspaces
- Also updated workspace-middleware.ts withWorkspaceAuth() for consistency
- **Files modified:** lib/api-workspace-guard.ts, lib/workspace-middleware.ts
- **Learnings:**
  - canAccessWorkspace return type is backward compatible — callers destructure { hasAccess, role } and ignore extra fields
  - workspace-middleware.ts has its own withWorkspaceAuth() that also calls canAccessWorkspace — must be kept in sync
---

## 2026-02-12 - D8-002
- Created lib/workspace-frozen-cache.ts — lightweight cached frozen check for webhook-auth contexts
- Added isWorkspaceFrozen() check to /api/events and /api/cost-events after resolveWebhookAuth
- Returns 403 'Workspace is frozen — events rejected' / 'cost events rejected'
- Separate cache from access guard (ingestion routes use webhook tokens, not Clerk auth)
- **Files created:** lib/workspace-frozen-cache.ts
- **Files modified:** app/api/events/route.ts, app/api/cost-events/route.ts
- **Learnings:**
  - Event/cost routes authenticate via webhook tokens, not Clerk — need separate frozen cache
  - invalidateFrozenCache() exported for freeze/unfreeze route to call
---

## 2026-02-12 - D8-003
- Freeze POST now sets workspaces.webhook_token = null (immediately blocks event auth)
- Freeze POST looks up sidecar URL from genesis.partition_registry and sends DEACTIVATE_ALL_WORKFLOWS
- Sidecar communication is best-effort (try-catch, 10s timeout, logs warning on failure)
- Unfreeze DELETE generates new webhook_token via crypto.randomUUID()
- New token included in unfreeze response and logged to governance_audit_log metadata
- Both handlers call invalidateFrozenCache() for D8-002 cache coherence
- **Files modified:** app/api/admin/freeze-workspace/route.ts
- **Learnings:**
  - webhook_token is a column on the workspaces table (used by resolveWebhookAuth Strategy 1)
  - (supabase as any).schema('genesis') pattern for partition_registry lookup
  - AbortController with setTimeout for HTTP timeout on sidecar calls
---

## 2026-02-12 - D8-004
- Created migration with BEFORE UPDATE OR DELETE trigger on governance_audit_log
- Trigger function prevent_audit_modification() raises exception to block modifications
- Uses CREATE OR REPLACE and DROP TRIGGER IF EXISTS for idempotency
- **Files created:** supabase/migrations/20260301_domain8_audit_log_immutable.sql
---

## 2026-02-12 - D8-005
- Extended existing Clerk webhook handler to handle session.created (login audit)
- Added ClerkSessionEvent type, login_audit inserts for session.created, user.created, user.deleted
- Created login_audit table migration with indexes on user_id, created_at, event_type
- Added /api/webhooks/clerk to public routes in proxy.ts (Svix auth, not Clerk auth)
- Graceful: login_audit inserts use try-catch in case table doesn't exist yet
- **Files created:** supabase/migrations/20260301_domain8_login_audit.sql
- **Files modified:** app/api/webhooks/clerk/route.ts, proxy.ts
- **Learnings:**
  - Clerk webhook handler already existed for user sync — extend, don't recreate
  - svix package already installed (^1.82.0)
  - proxy.ts has isPublicRoute matcher — webhook endpoints must be listed there
---

## 2026-02-12 - D8-006
- Created genesis.watchdog_runs and genesis.watchdog_drifts tables with indexes
- Implemented SupabaseWatchdogDB class implementing WatchdogDB interface
- Drift detection methods return [] (detection logic is in StateReconciliationWatchdog, not DB layer)
- storeDrift, updateDrift, createRun, updateRun, getRecentRuns all use genesis schema
- Added getDriftsForRun() and getDrifts() with optional filters for querying
- Temp ID pattern (temp-${Date.now()}) for createRun failures — skips updateRun silently
- **Files created:** supabase/migrations/20260301_domain8_watchdog_persistence.sql, lib/genesis/phase43/supabase-watchdog-db.ts
- **Learnings:**
  - WatchdogDB interface has detection methods AND storage methods — DB impl focuses on storage
  - getTypedSupabaseAdmin() + .schema('genesis') pattern for genesis tables
  - WatchdogRunResult has many fields — map DB rows carefully with defaults
---

## 2026-02-12 - D8-007
- Created GET /api/admin/watchdog/run — admin-only route to trigger watchdog cycle
- Route gets all active workspaces, creates run record, checks for missing_partition drifts
- Returns JSON summary: { run_id, drifts_found, workspaces_scanned, duration_ms }
- Updated control-plane/src/services/watchdog.ts for Redis graceful degradation
- Redis/BullMQ init wrapped in try-catch — degraded mode logs critical alerts instead of queuing reboots
- isHealthy() returns false in degraded mode; getHealth() surfaces degraded_reason
- **Files created:** app/api/admin/watchdog/run/route.ts
- **Files modified:** control-plane/src/services/watchdog.ts
- **Learnings:**
  - Full drift detection requires N8nClient (external API) — admin route does DB-level checks only
  - Control-plane watchdog executes reboot actions via BullMQ queue — without Redis, must degrade gracefully
  - ServiceHealth type may need extending for degraded fields (cast as ServiceHealth for now)
---

## 2026-02-12 - INFRA-001 through INFRA-006
Branch: ralph/infra-free-tier-hardening

- **INFRA-001** (4556339): Created .github/workflows/ci.yml — Node 20, tsc --noEmit, npm test. Lint skipped (Next.js 16 removed next lint, ESLint 9 needs flat config migration).
- **INFRA-002** (92336bc): Installed @sentry/nextjs. Created sentry.client/server/edge.config.ts (tracesSampleRate: 0.1, replays: 0, production-only). Wrapped next.config.js with withSentryConfig. Wired Sentry.captureException in lib/swr-config.tsx onError.
- **INFRA-003** (8165d05): Created control-plane/src/services/telegram.ts (sendTelegramAlert helper). Wired into watchdog.ts for 'alert' actions with workspace/droplet/reason context.
- **INFRA-004** (e8c7829): Wired sendTelegramAlert into scale-alerts.ts — evaluatePartitions, evaluateRowCount, and evaluateConnections all send CRITICAL or WARNING Telegram alerts.
- **INFRA-005** (3091256): Applied FTS migration via Supabase MCP — added search_vector tsvector column (GENERATED from name) and GIN index to campaigns table. Contacts table does not exist.
- **INFRA-006** (b4fc10a): Updated app/api/search/route.ts — FTS via textSearch with websearch type for campaigns, ILIKE fallback if FTS returns 0 results or search_vector column missing.

**Learnings:**
- Next.js 16 dropped next lint command — need separate ESLint flat config migration
- @sentry/nextjs withSentryConfig: use disableServerWebpackPlugin + disableClientWebpackPlugin for free tier (no source map upload)
- Telegram Bot API accepts Markdown in parse_mode — use for structured alert messages
- contacts table never created — search route already handled this gracefully with as any cast
- tsvector GENERATED ALWAYS AS + GIN index is the idiomatic Postgres FTS approach for simple single-column search
---

## Onboarding Redesign (branch: ralph/onboarding-redesign)
- **ONB-001** (7c43c89): Redesigned right-sidebar stepper — numbered circles, dashed connectors, time estimate, removed icons
- **ONB-002** (65aff01): Clean text-only stage headers matching Settings page, removed top progress bar, removed card border
- **ONB-003** (b7e0b24): Refined navigation footer — Skip for optional stages, Save & Continue Later with toast, right-aligned layout
- **ONB-004** (dd44770): Form draft auto-save system — migration (drafts JSONB column), API route (GET/PUT), useOnboardingDraft hook, draft clearing on stage completion
- **ONB-005** (f95686e): Integrated useOnboardingDraft into 9 stage components (brand-info, api-key-input, smtp-configuration, calendly-url, relevance-key, apify-selection, dns-setup, region-selection, email-provider-selection)
- **ONB-006** (4088820): Resume banner — "Welcome back! You left off at [stage]." for returning users with prior progress
- **ONB-007** (ec61443): Mobile stepper — replaced bottom dot pills with top header bar (stage name + Step X/Y + progress bar) and BottomSheet with full stepper
- **PRD**: ralph-loop/prd-onboarding-redesign.json — all 7 stories pass
- **Files created**: app/api/onboarding/draft/route.ts, hooks/use-onboarding-draft.ts, supabase/migrations/20260228_add_onboarding_drafts.sql
- **Files modified**: genesis-onboarding-wizard.tsx, onboarding-progress-service.ts, + 9 stage components
---