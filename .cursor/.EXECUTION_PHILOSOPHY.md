# GENESIS V35 EXECUTION PHILOSOPHY
## READ THIS BEFORE EVERY ACTION

---

## THE IRONCLAD LAWS (NON-NEGOTIABLE)

### LAW #1: ONE PHASE AT A TIME
- Complete the ENTIRE phase before moving to the next
- This includes: implementation, testing, verification, documentation
- Never implement multiple phases simultaneously
- Never "batch" phases for efficiency

### LAW #2: ISOLATED DEVELOPMENT

**Default: Separate Branch + Isolated Test Run**
- Create feature branch: `phase-{N}-{name}`
- Implement in proper locations (`lib/genesis/phase{N}/`, `app/api/`)
- Run tests ONLY for new code: `npm test -- phase{N}`
- Verify zero impact on existing tests: `npm test`

**When to use Isolated Directory (`genesis-phase{N}/`):**
- Phase modifies existing core systems (auth, routing, state management)
- Phase has unclear dependencies on main codebase
- Phase is experimental/prototype
- You're uncertain about integration complexity

**Decision Criteria:**
- Additive phase (new files only)? ‚Üí Separate branch
- Modifying existing code? ‚Üí Isolated directory
- When in doubt? ‚Üí Isolated directory (safer)

**Why this approach:**
- Separate branch is default (better git workflow, less friction)
- Isolated directory reserved for risky changes (where it adds most value)
- Still requires isolated test run (proves modularity)
- Keeps the spirit of the law (prove your code works in isolation)

### LAW #3: INTEGRATION PROTOCOL
**Do NOT integrate until ALL of these are complete:**
1. ‚úÖ All implementation code written
2. ‚úÖ All tests written (60+ minimum)
3. ‚úÖ All tests passing in isolated environment
4. ‚úÖ Coverage meets threshold (85%+ statements)
5. ‚úÖ Zero linter errors
6. ‚úÖ Documentation updated in GENESIS_SINGULARITY_PLAN_V35.md ONLY
7. ‚úÖ Phase marked complete in plan

**Integration Steps (Sequential, No Shortcuts):**
1. Copy code to `lib/genesis/`
2. Run tests from NEW location
3. Verify all tests still pass
4. Check for breaking changes in existing codebase
5. Run existing test suite (must stay at 100%)
6. ONLY THEN delete isolated environment

### LAW #4: DOCUMENTATION DISCIPLINE
**ONLY edit these 2 files for progress tracking:**
1. `docs/plans/GENESIS_SINGULARITY_PLAN_V35.md` - Progress reports ONLY
2. `.cursor/.EXECUTION_PHILOSOPHY.md` - This file (execution reminders)

**NEVER create:**
- Summary documents
- Integration reports
- Status files
- Any other MD files for Genesis progress

### LAW #5: QUALITY STANDARD
- **Minimum**: 99.9999999999999999% (16 nines)
- If you think you're "done early", you missed something
- Comprehensive testing is NOT optional
- Edge cases are NOT optional
- Security verification is NOT optional

### LAW #6: UNDERSTAND BEFORE CHANGING (Part VI+)
- **For UI work**: Map existing architecture FIRST
- Read ALL existing components before creating new ones
- Understand routing, state, layouts BEFORE coding
- NEVER simplify intentionally complex systems
- ADAPTATION not replacement
- Preserve existing functionality at ALL costs

---

## SELF-CHECK BEFORE MARKING PHASE COMPLETE

Ask yourself:
- [ ] Did I test ALL error paths?
- [ ] Did I test edge cases (empty data, max limits, special characters)?
- [ ] Did I test race conditions and concurrency?
- [ ] Did I test timeout scenarios?
- [ ] Did I verify security properties?
- [ ] Did I test rollback/cancellation?
- [ ] Did I run tests from the integrated location?
- [ ] Did I verify existing tests still pass?
- [ ] Did I update ONLY the main plan document?
- [ ] Am I CERTAIN this is production-ready?

---

## WHY THESE RULES EXIST

**The 25,000-line, 35-version plan exists because:**
- Genesis is managing 15,000 sovereign stacks
- Silent failures compound exponentially
- A bug in Phase 41 affects ALL future phases
- Rushing creates technical debt that becomes unfixable

**Evidence:**
- Phase 41 initial implementation: "worked", tests passed
- Phase 41 proper implementation: Found 4 CRITICAL bugs
- Quality difference: 95% ‚Üí 99.9999999999999999%

**The difference**: Production failures vs production-ready

---

## REMEMBER

"If I'm finishing early, I'm not finished."
"One phase at a time means ONE PHASE AT A TIME."
"The plan is battle-tested wisdom, not bureaucracy."

---

---

# ‚úÖ PART IV: FLEET OPERATIONS - COMPLETE (2026-01-27)

**Status**: 100% Complete & Integrated into `lib/genesis/phase43-56/`

**Implementation Summary**:
- ‚úÖ Phase 43: State Reconciliation Watchdog (drift detection, auto-healing)
- ‚úÖ Phase 54: Heartbeat State Machine (10 health states, zombie detection)
- ‚úÖ Phase 55: Hibernation & Wake Physics (cost optimization, $5.50/tenant savings)
- ‚úÖ Phase 56: Fleet-Wide Template Reconciliation (blue-green updates, batched rollout)

**Totals**: 4/4 phases, ~4,770 LOC, 130+ type definitions, 8 mock classes, 45+ constants

**Quality Metrics**: Production-ready code, comprehensive types, full integration between phases

---

# ‚úÖ PART V: FINANCIAL & BILLING - COMPLETE (2026-01-27)

**Status**: 100% Complete & Integrated into `lib/genesis/phase58-59/`

**Implementation Summary**:
- ‚úÖ **Phase 58**: Financial Kill-Switch & Genesis Wallet (258 tests, 16-nines quality)
  - 9 sub-modules: Wallet Core, Transaction Manager, Kill-Switch, Auto-Topup, Budget Manager, Analytics, Invoicing, Audit Logger, Payment Manager
  - 175 hardening tests added (concurrency, timeouts, security, edge cases, error paths)
  - Zero linter errors, production-ready
- ‚úÖ **Phase 59**: Cost Model & Rate Limit Orchestration (62 tests, 16-nines quality)
  - 3 production modules: Cost Ledger Manager, Margin Analyzer, Rate Limit Manager
  - ~2,540 LOC, 50+ type definitions, 100% passing tests
  - Token bucket algorithm, queue management, CLV projections, margin analysis

**Totals**: 2/2 phases, ~2,540 LOC (Phase 59), 320 total tests, 100% pass rate

**Quality Metrics**: 
- ‚úÖ Battle-tested (all tests run and verified)
- ‚úÖ 16-nines quality standard achieved for both phases
- ‚úÖ Zero linter errors across all files
- ‚úÖ Full TypeScript coverage with comprehensive types
- ‚úÖ Production-ready code with extensive error handling

---

# üìã PART VI: ONBOARDING ARCHITECTURE & CAMPAIGN OPERATIONS ‚úÖ **COMPLETE** (2026-01-27)

**Status**: All 12 phases complete (Phase 60, 60.A-D, 61, 61.A-C, 62.A-B, 63)

## PLANNING SUMMARY

**What was completed:**
- ‚úÖ Complete Part VI architecture refined through extensive Q&A
- ‚úÖ All phases detailed: 60, 60.A-D, 61, 61.A-C, 62, 62.A-B, 63
- ‚úÖ End-to-end user + admin journey mapped (30 steps)
- ‚úÖ Critical architectural decisions finalized:
  - n8n access: Admin-only (no user access)
  - Workflow structure: 7 workflows per campaign (Hybrid approach)
  - Risk system: Warn, don't block
  - Trial mode: Deferred (payment required upfront)
  - Notifications: Gmail + Telegram only
  - Campaign cloning: Clone first campaign, preserves credentials
  - n8n authentication: User Management with email (not Basic Auth)
- ‚úÖ 60+ item admin checklist defined
- ‚úÖ Hybrid detection system (auto + manual confirmation)
- ‚úÖ Time tracking for optimization
- ‚úÖ Error retry (3 attempts) + 24h escalation
- ‚úÖ Engine Starting page with 5-stage progress indicator

**Documentation**: All details in `docs/plans/GENESIS_SINGULARITY_PLAN_V35.md` (Part VI, lines ~6935-8200)

**Phase 60 Completion (2026-01-27):**
- ‚úÖ Implementation: Onboarding state machine, routing manager, setup state manager
- ‚úÖ Tests: 105 tests, 100% passing
- ‚úÖ Coverage: 98.76% statements, 96.96% branches
- ‚úÖ Integration: Code in `lib/genesis/phase60/`, tests in `__tests__/genesis/phase60/`

**Phase 60.A Completion (2026-01-27):**
- ‚úÖ Implementation: 6 signal providers, risk scoring engine
- ‚úÖ Tests: 91 tests, 100% passing
- ‚úÖ Coverage: 99.49% statements, 97.36% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase60a/`, tests in `__tests__/genesis/phase60a/`

**Phase 60.B Completion (2026-01-27):**
- ‚úÖ Implementation: 5 stage validators, onboarding flow manager, 6-stage streamlined flow
- ‚úÖ Tests: 67 tests, 100% passing
- ‚úÖ Coverage: 99.58% statements, 97.56% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase60b/`, tests in `__tests__/genesis/phase60b/`

**Phase 60.C Completion (2026-01-27):**
- ‚úÖ Implementation: 6 notification types, Gmail/Telegram channels, dispatcher, template system
- ‚úÖ Tests: 63 tests, 100% passing
- ‚úÖ Coverage: 99.29% statements, 97.82% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase60c/`, tests in `__tests__/genesis/phase60c/`

**Phase 60.D Completion (2026-01-27):**
- ‚úÖ Implementation: Credential generator, admin access manager, config generator, n8n User Management support
- ‚úÖ Tests: 98 tests, 100% passing
- ‚úÖ Coverage: 98.91% statements, 96.05% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase60d/`, tests in `__tests__/genesis/phase60d/`

**Phase 61 Completion (2026-01-27):**
- ‚úÖ Implementation: Campaign status machine, campaign manager, tier limits, validation
- ‚úÖ Tests: 78 tests, 100% passing
- ‚úÖ Coverage: 100% statements, 97.61% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase61/`, tests in `__tests__/genesis/phase61/`

**Phase 61.A Completion (2026-01-27):**
- ‚úÖ Implementation: Campaign creation wizard, multi-step flow, validation
- ‚úÖ Tests: 42 tests, 100% passing
- ‚úÖ Coverage: 100% statements, 100% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase61a/`, tests in `__tests__/genesis/phase61a/`

**Phase 61.B Completion (2026-01-27):**
- ‚úÖ Implementation: CSV parser, validator, importer with file size/row limits
- ‚úÖ Tests: 104 tests, 100% passing
- ‚úÖ Coverage: 95.24% statements, 89.85% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase61b/`, tests in `__tests__/genesis/phase61b/`

**Phase 61.C Completion (2026-01-27):**
- ‚úÖ Implementation: Workflow namer, cloner, query generator
- ‚úÖ Tests: 77 tests, 100% passing
- ‚úÖ Coverage: 96.8% statements, 93.33% branches, 97.22% functions
- ‚úÖ Integration: Code in `lib/genesis/phase61c/`, tests in `__tests__/genesis/phase61c/`

**Phase 62.A Completion (2026-01-27):**
- ‚úÖ Implementation: Wallet balance checker, cost breakdown calculator
- ‚úÖ Tests: 79 tests, 100% passing
- ‚úÖ Coverage: 100% statements, 93.54% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase62a/`, tests in `__tests__/genesis/phase62a/`

**Phase 62.B Completion (2026-01-27):**
- ‚úÖ Implementation: Rate limit key generator, rate limit checker, 6 limit types
- ‚úÖ Tests: 150 tests, 100% passing
- ‚úÖ Coverage: 99.1% statements, 89.55% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase62b/`, tests in `__tests__/genesis/phase62b/`

**Phase 63 Completion (2026-01-27):**
- ‚úÖ Implementation: 44-item checklist system, manager, progress tracker
- ‚úÖ Tests: 85 tests, 100% passing
- ‚úÖ Coverage: 99.47% statements, 95.78% branches, 100% functions
- ‚úÖ Integration: Code in `lib/genesis/phase63/`, tests in `__tests__/genesis/phase63/`
- ‚úÖ Quality: Zero TypeScript errors, 16-nines standard achieved
- üéâ **PART VI COMPLETE**: All 12 phases implemented and tested
- ‚è≠Ô∏è **Ready for Part VII**: Onboarding & UX (requires Phase 0: Frontend Architecture Discovery)

---

# üìã PART VII: ONBOARDING UX & FRICTION REDUCTION ‚úÖ **100% COMPLETE** (2026-01-31)

**Status**: ALL phases complete (64, 64.B, 65.1-65.4), integrated, committed to GitHub

## PHASE 64: GENESIS GATEWAY OAUTH PROXY ‚úÖ COMPLETE

**Implementation Summary:**
- ‚úÖ Phase 0: Frontend Architecture Discovery (15 files mapped)
- ‚úÖ Isolated Development: 5,300+ LOC in `genesis-phase64/`
- ‚úÖ Backend Services: 6 production services (~1,800 LOC)
- ‚úÖ Frontend Components: 13 UI components (~1,500 LOC)
- ‚úÖ API Routes: 7 endpoints (~560 LOC)
- ‚úÖ Database Schema: 5 tables with RLS policies
- ‚úÖ Tests: **177 tests, 100% passing**
- ‚úÖ Integration: All files moved to production locations
- ‚úÖ Quality: Zero TypeScript errors, zero linting errors
- ‚úÖ Security: AES-256-GCM encryption, CSRF protection, workspace-scoped keys
- üéâ **PHASE 64 COMPLETE & INTEGRATED**

**What Was Built:**
- Zero-trust credential vault (workspace-scoped encryption)
- Real-time API key validation (6 providers)
- Gmail OAuth proxy (Genesis-operated OAuth app)
- Droplet region/size selection (5 regions, 4 sizes)
- 11-stage onboarding wizard (reduces setup from 3-5 hours to ~15 minutes)
- Brand information vault (with auto-scrape hooks)
- Onboarding progress tracking (resume capability)

**Files:**
- Backend: `lib/genesis/phase64/*.ts`
- Frontend: `components/genesis/*.tsx`, `components/genesis/stages/*.tsx`
- API: `app/api/onboarding/*`, `app/api/oauth/gmail/*`
- Page: `app/onboarding/page.tsx`
- Tests: `__tests__/genesis/phase64/*.test.ts`
- Migration: `supabase/migrations/20260130_002_phase64_genesis_gateway.sql`

## PHASE 64.B: EMAIL PROVIDER ABSTRACTION ‚úÖ COMPLETE (2026-01-31)
- ‚úÖ Sidecar SMTP/IMAP service (smtp-service.ts, /send, /check-reply)
- ‚úÖ Onboarding Email Provider Selection stage (conditional Gmail/SMTP)
- ‚úÖ SMTP Configuration stage (form with connection test)
- ‚úÖ SMTP Workflow Templates (Email 1/2/3-SMTP.json)
- ‚úÖ Sidecar Workflow Deployment Logic (workflow-deployer.ts)
- ‚úÖ Provider-based deployment (deploy ONLY selected provider's workflows)
- ‚úÖ 77 tests passing (100%), 95.20% coverage
- ‚úÖ Multi-provider support: Gmail (OAuth), SMTP (custom), SendGrid (API)

## PHASE 65: FRICTION-REDUCTION PROTOCOLS ‚úÖ **ALL 4 SUB-PHASES COMPLETE** (2026-01-31)

**Phase 65.1: Brand Metadata Auto-Scraper** ‚úÖ COMPLETE
- ‚úÖ Simple metadata fetch via HTTP GET + HTML parsing (Option B)
- ‚úÖ Extracts: Company Name, Logo URL, Brief Description
- ‚úÖ Open Graph tags (og:title, og:image, og:description) + fallbacks
- ‚úÖ Immediate fallback on 403/429/timeout (5s max)
- ‚úÖ API: `POST /api/onboarding/brand/auto-scrape`
- ‚úÖ UI: Logo field added to brand-info-stage
- ‚úÖ 69 tests passing (100%), 97.84% coverage

**Phase 65.2: DNS Automation (SPF/DKIM/DMARC)** ‚úÖ COMPLETE
- ‚úÖ `dns-record-generator.ts` - Generates SPF, DKIM, DMARC records
- ‚úÖ `dns-verifier.ts` - DNS-over-HTTPS verification (Cloudflare + Google)
- ‚úÖ `entri-integration.ts` - Optional Entri API integration
- ‚úÖ **Dual-Mode Architecture**: Manual (free) + Entri (premium)
- ‚úÖ API: `/api/onboarding/dns/generate`, `/api/onboarding/dns/verify`, `/api/onboarding/dns/entri/*`
- ‚úÖ UI: Updated `dns-setup-stage.tsx` with dual-mode selection
- ‚úÖ 102 tests passing (100%), 92.81% coverage

**Phase 65.3: Calendly Link Validator** ‚úÖ COMPLETE
- ‚úÖ `calendly-validator.ts` - Booking link validation
- ‚úÖ Format validation (HTTPS, provider detection, path required)
- ‚úÖ Accessibility check (HEAD request, 200 OK)
- ‚úÖ Content validation (optional, booking keywords)
- ‚úÖ Supports: Calendly, Cal.com, SavvyCal, Chili Piper, custom systems
- ‚úÖ API: `POST /api/onboarding/validate-calendly`
- ‚úÖ UI: Comprehensive validation UI in calendly-url-stage
- ‚úÖ 67 tests passing (100%), 97.84% coverage

**Phase 65.4: Custom Tracking Domains** ‚úÖ COMPLETE
- ‚úÖ `tracking-domain-manager.ts` - Custom tracking domain CNAME generation
- ‚úÖ `tracking-domain-verifier.ts` - DNS-over-HTTPS CNAME verification
- ‚úÖ **Dual-Mode Architecture**: Manual (free) + Entri (premium)
- ‚úÖ Manual Mode: Generate CNAME, copy-paste to DNS provider
- ‚úÖ Recommended subdomains: track, click, links, go
- ‚úÖ sslip.io fallback for DNS-less testing
- ‚úÖ DNS propagation checker (estimates global propagation)
- ‚úÖ API: `/api/onboarding/tracking/setup`, `/api/onboarding/tracking/verify`
- ‚úÖ 66 tests passing (100%), 99.30% coverage

**PHASE 65 COMBINED METRICS:**
- ‚úÖ **304 total tests passing (100% pass rate)** (Phase 64.B: 77 + Phase 65: 288 = 365 total for Part VII phases 64.B & 65)
- ‚úÖ **Coverage: 95.62% avg statements, 89.86% avg branches**
- ‚úÖ **Zero linter errors**
- ‚úÖ **Zero TypeScript compilation errors**
- ‚úÖ Code: `lib/genesis/phase65/`, `lib/genesis/phase65-2/`
- ‚úÖ API: **8 endpoints** (brand, calendly, DNS, tracking)
- ‚úÖ UI: 3 stages enhanced (brand-info, dns-setup, calendly-url)
- ‚úÖ **Committed to GitHub:** 391 files, 125,556 insertions (2026-01-31)
- üéâ **PART VII 100% COMPLETE**

**Part VII Total Metrics:**
- **Phases:** 64, 64.B, 65.1, 65.2, 65.3, 65.4 (all complete)
- **Tests:** 426+ tests (Phase 64: 45 + Phase 64.B: 77 + Phase 65: 304 = 426)
- **Coverage:** 95%+ average across all phases
- **API Endpoints:** 15+ new endpoints
- **UI Components:** 16+ new/enhanced components

---

# üéØ WHERE WE ARE NOW (2026-02-01)

**Last Work Date:** 2026-01-31 (Phase 65 completed)  
**Days Since Last Work:** 4 days  
**Last Action:** Committed 391 files (125,556 additions) to GitHub

## ‚úÖ COMPLETE: PARTS I-VII (64% of Genesis Singularity Plan)

**Parts Complete:**
- ‚úÖ **Part I:** Strategic Architecture (Documentation)
- ‚úÖ **Part II:** Infrastructure Physics (3 phases)
- ‚úÖ **Part III:** Orchestration & Communication (4 phases, 225 tests)
- ‚úÖ **Part IV:** Fleet Operations (4 phases, ~4,770 LOC)
- ‚úÖ **Part V:** Financial & Billing (3 phases, 420+ tests)
- ‚úÖ **Part VI:** Onboarding Architecture (13 phases)
- ‚úÖ **Part VII:** Onboarding UX & Friction Reduction (6 phases, 426+ tests)

**Total Progress:**
- **25+ phases implemented**
- **1,500+ tests passing**
- **125,556+ lines of code**
- **0 TypeScript errors**
- **0 npm vulnerabilities (production)**
- **All committed to GitHub**

## ‚è≥ INCOMPLETE: PARTS VIII-XI (36% remaining)

**Remaining:**
- ‚è≥ **Part VIII:** Compliance & Security (4 phases) - **NEXT UP: Phase 66**
- ‚è≥ **Part IX:** Platform Operations (3 phases)
- ‚è≥ **Part X:** Migration & Deployment (8 phases)
- ‚è≥ **Part XI:** Reference & Appendices (5 appendices)

## üéØ NEXT PHASE: Phase 66 - Data Residency & GDPR Protocol

**What it includes:**
1. Multi-region data storage (partition-droplet co-location)
2. GDPR compliance (right to deletion, data export)
3. Data residency rules (EU data stays in EU regions)
4. Region-specific partition routing

**Dependencies:** ‚úÖ All satisfied (Parts II, VI, VII complete)

**Recommended Approach:**
- Start in fresh context window
- Follow isolated development workflow
- 60+ comprehensive tests
- 16-nines quality standard

**Context to Provide:**
```
Status: Phase 65 complete (all 4 sub-phases)
Committed: 391 files, 125,556 insertions (2026-01-31)
Database: All migrations applied to Supabase
Tests: 1,500+ tests passing
Next: Phase 66 (Data Residency & GDPR)
Plan: @docs/plans/GENESIS_SINGULARITY_PLAN_V35.md
```

**Build Status:** ‚úÖ All build errors fixed (user confirmed 2026-02-01)

**Next:** Ready for Phase 66 or next priorities

---

## ‚ö†Ô∏è CRITICAL: PART VII SPECIAL REQUIREMENTS (BEFORE IMPLEMENTATION)

**Part VII is UI-heavy. This changes EVERYTHING about the workflow.**

### üö® MANDATORY PHASE 0: FRONTEND ARCHITECTURE DISCOVERY

**BEFORE implementing ANY Phase 60/60.B/61 code, you MUST:**

1. **Map the Entire Existing UI Architecture**
   - Read ALL files in `app/` (routing structure)
   - Read ALL files in `components/` (component hierarchy)
   - Read ALL files in `hooks/` (state management patterns)
   - Understand layouts: `components/layout/`
   - Understand providers: `components/providers/`
   - Understand mobile components: `components/mobile/`

2. **Document Current State** (in your working memory, not files)
   - Which pages exist and their routes
   - Component nesting hierarchy
   - How authentication flows work
   - How backend API calls are structured (`app/api/*`)
   - Existing design patterns (shadcn/ui, Tailwind)
   - Current navigation patterns
   - Where settings/configuration lives

3. **Map Backend-Frontend Connections**
   - How does frontend call Genesis Phase 58 wallet APIs?
   - How are workspace contexts passed?
   - What's the authentication flow?
   - How are errors displayed to users?
   - What's the toast/notification system?

4. **Understand Design System**
   - Read `components/ui/` completely
   - Understand existing component patterns
   - Note color schemes, spacing, typography
   - Identify reusable patterns

**üõë DO NOT WRITE A SINGLE LINE OF CODE UNTIL THIS IS COMPLETE.**

### üìù DETAILED DISCOVERY CHECKLIST

**When mapping existing frontend, document:**

**Layout & Positioning:**
- [ ] Root layout structure (`app/layout.tsx`)
- [ ] Dashboard layout hierarchy
- [ ] Sidebar positioning and behavior
- [ ] Header/navigation placement
- [ ] Mobile responsive breakpoints
- [ ] Z-index layers for modals/overlays
- [ ] Scroll container hierarchy

**Component Architecture:**
- [ ] Which components are client vs server
- [ ] Component composition patterns
- [ ] Shared component library usage
- [ ] Form components and validation patterns
- [ ] Modal/dialog patterns
- [ ] Toast/notification system
- [ ] Loading states and skeletons

**Routing & Navigation:**
- [ ] App router structure (`app/*/page.tsx`)
- [ ] Dynamic routes and params
- [ ] Nested route patterns
- [ ] Navigation guards/middleware
- [ ] Redirect flows
- [ ] Deep linking patterns

**State Management:**
- [ ] Context providers hierarchy
- [ ] Custom hooks and their purpose
- [ ] Client state patterns
- [ ] Server state patterns (React Query, SWR, etc.)
- [ ] Form state management
- [ ] Global vs local state boundaries

**Backend Integration:**
- [ ] API route structure (`app/api/*/route.ts`)
- [ ] How frontend calls APIs (fetch, axios, etc.)
- [ ] Error handling patterns
- [ ] Loading/success/error states
- [ ] Authentication headers
- [ ] Workspace context passing

**Design System:**
- [ ] Tailwind configuration
- [ ] Custom CSS patterns
- [ ] Component variants (shadcn/ui)
- [ ] Color palette and usage
- [ ] Typography scale
- [ ] Spacing system
- [ ] Animation patterns

**Existing Features to Preserve:**
- [ ] Dashboard overview page
- [ ] Analytics page
- [ ] Contacts page
- [ ] Sequences page
- [ ] Settings page
- [ ] Admin page
- [ ] Campaign components
- [ ] Workspace switching

**Integration Points for Part VI:**
- [ ] Where OAuth flow should hook in
- [ ] Where credential forms should appear
- [ ] Where onboarding wizard should live
- [ ] Which layouts to extend
- [ ] Which navigation to modify
- [ ] Where settings should integrate

### üéØ PART VI EXECUTION RULES

**Rule #1: ADAPTATION, NOT REPLACEMENT**
- ‚ùå NEVER change existing dashboard functionality
- ‚ùå NEVER simplify complex existing systems
- ‚úÖ ALWAYS extend and adapt to what exists
- ‚úÖ ALWAYS match existing design patterns
- ‚úÖ ALWAYS preserve existing component hierarchy

**Rule #2: UNDERSTAND BEFORE IMPLEMENTING**
- Phase 60 onboarding EXTENDS existing auth, doesn't replace it
- New components INTEGRATE into existing layouts
- New routes FOLLOW existing routing patterns
- New API calls MATCH existing API structure

**Rule #3: USE SKILLS APPROPRIATELY**

**Frontend-Design Skill:**
- ‚úÖ Use for NEW onboarding components
- ‚úÖ Use to match existing design system
- ‚úÖ Use for OAuth flows, credential forms
- ‚ùå Do NOT use to redesign existing dashboard

**Browser MCP (cursor-ide-browser):**
- ‚úÖ Use to test new onboarding flows
- ‚úÖ Use to verify OAuth redirects
- ‚úÖ Use to test form submissions
- ‚úÖ Use after backend + frontend are complete

**Rule #4: COMPLEXITY IS INTENTIONAL**
- If existing code is complex, there's a reason
- If routing is nested, preserve it
- If state management is intricate, match it
- Do NOT try to "simplify" or "clean up" existing patterns

### üìã MODIFIED WORKFLOW FOR PART VI

```
PHASE 0 (DISCOVERY - MANDATORY):
‚îú‚îÄ‚îÄ Map app/ routing structure
‚îú‚îÄ‚îÄ Map components/ hierarchy  
‚îú‚îÄ‚îÄ Map hooks/ and state patterns
‚îú‚îÄ‚îÄ Understand backend integration
‚îú‚îÄ‚îÄ Document design system
‚îî‚îÄ‚îÄ ‚úÖ Architecture understanding complete

PHASE IMPLEMENTATION (60/60.B/61):
‚îú‚îÄ‚îÄ Week 1: Backend Logic
‚îÇ   ‚îú‚îÄ‚îÄ Isolated development (genesis-phase60/)
‚îÇ   ‚îú‚îÄ‚îÄ 40+ backend tests
‚îÇ   ‚îî‚îÄ‚îÄ Zero frontend changes yet
‚îÇ
‚îú‚îÄ‚îÄ Week 2: Frontend Components
‚îÇ   ‚îú‚îÄ‚îÄ USE frontend-design skill
‚îÇ   ‚îú‚îÄ‚îÄ Create NEW components only
‚îÇ   ‚îú‚îÄ‚îÄ Match existing patterns exactly
‚îÇ   ‚îú‚îÄ‚îÄ Extend existing layouts
‚îÇ   ‚îî‚îÄ‚îÄ 20+ component tests
‚îÇ
‚îî‚îÄ‚îÄ Week 3: Integration & Testing
    ‚îú‚îÄ‚îÄ USE browser MCP for E2E tests
    ‚îú‚îÄ‚îÄ Verify no existing functionality broken
    ‚îú‚îÄ‚îÄ Test new onboarding flows
    ‚îî‚îÄ‚îÄ ‚úÖ Integration complete
```

### üö® CRITICAL WARNINGS

**YOU WILL FAIL IF YOU:**
- Skip architecture discovery phase
- Change existing dashboard components
- Simplify complex existing patterns
- Create inconsistent UI components
- Break existing routing
- Modify existing API routes without understanding them

**YOU WILL SUCCEED IF YOU:**
- Spend time understanding BEFORE coding
- Ask questions about existing architecture
- Extend rather than replace
- Match existing patterns exactly
- Test against existing functionality
- Preserve complexity where it exists

### üí° RECOMMENDED OPENING PROMPT FOR PART VI

```
Begin Part VI (Onboarding & UX) of Genesis V35 implementation.

Context:
- Part IV (Fleet Operations): ‚úÖ COMPLETE
- Part V (Financial & Billing): ‚úÖ COMPLETE (Phase 58 + 59, 320 tests)
- Current status in: .cursor/.EXECUTION_PHILOSOPHY.md

CRITICAL PHASE 0 REQUIREMENTS:
Before implementing Phase 60, I need to:
1. Map the ENTIRE existing frontend architecture
2. Understand component hierarchy, routing, layouts
3. Understand how frontend integrates with backend APIs
4. Document existing design patterns
5. Identify integration points for new onboarding components

Read these files to understand current state:
- All files in app/ (routing)
- All files in components/ (UI hierarchy)
- All files in hooks/ (state management)
- All files in app/api/ (backend integration patterns)

DO NOT write any code until architecture discovery is complete.

After discovery:
- Use frontend-design skill for NEW onboarding components
- Use cursor-ide-browser MCP for E2E testing
- Follow 16-nines quality standard
- 60+ tests per phase
- EXTEND existing UI, do NOT replace or simplify

Start with Phase 0: Frontend Architecture Discovery
```

---

## THE CONTEXT (Part V - Legacy, Keep for Reference)

You are continuing the Genesis V35 implementation. **Part IV (Fleet Operations) is 100% complete** with all phases integrated into `lib/genesis/phase43-56/`.

**Your task**: Implement **Part V: Financial & Billing** following the proven isolated development workflow.

---

## PART V PHASES TO IMPLEMENT

From `docs/plans/GENESIS_SINGULARITY_PLAN_V35.md`:

| Phase | Title | Focus |
|-------|-------|-------|
| **57** | Managed vs. BYO Service Matrix | Service categorization, cost allocation |
| **58** | Financial Kill-Switch & Genesis Wallet | Pre-flight balance checks, wallet management |
| **59** | Cost Model & Rate Limit Orchestration | Per-tenant margins, external API quotas |

**Dependency order**: Check the plan document for exact dependencies between phases.

---

## QUALITY STANDARD

**Minimum**: 99.9999999999999999% (16 nines) - Production Ready

- Production-ready code with comprehensive type safety
- Isolated development per phase (`genesis-phase{N}/`)
- Integration after each phase completion
- Zero linter errors
- All error paths considered
- Security properties defined
- Mock implementations for testing

---

## THE REFINED WORKFLOW (CRITICAL IMPROVEMENTS FROM PART III)

### **Stage 1: ISOLATED DEVELOPMENT** (Per Phase)

1. **Create isolated environment**: `genesis-phase{N}/`
2. **Implement phase**: Following the plan specification exactly
3. **Write comprehensive tests**: Minimum 60 tests per phase
4. **Verify in isolation**: All tests passing, coverage met, zero linter errors
5. **Document in plan**: Update `GENESIS_SINGULARITY_PLAN_V35.md` with phase completion metrics

### **Stage 2: INCREMENTAL INTEGRATION** (NEW - Per Phase)

**Critical**: Test integration **per-phase** instead of bulk integration at the end.

For EACH completed phase:

1. **Copy to main codebase**:
   ```bash
   cp -r genesis-phase{N}/lib/* lib/genesis/phase{N}/
   cp -r genesis-phase{N}/__tests__/* __tests__/genesis/phase{N}/
   ```

2. **Update exports INCREMENTALLY**:
   - Add phase exports to `lib/genesis/index.ts`
   - Document what you're exporting (types, classes, functions)
   - Run `npx tsc --noEmit lib/genesis/index.ts` to verify

3. **Fix imports in tests**:
   - Update from `../lib/...` to `@/lib/genesis/...`
   - Verify module resolution works

4. **Test from integrated location**:
   ```bash
   cd __tests__/genesis && npx jest phase{N}/
   ```
   - Must pass ALL tests before proceeding
   - If tests fail, fix immediately before next phase

5. **Verify no breaking changes**:
   ```bash
   npm test  # Main codebase must stay at 100%
   ```

6. **Only THEN delete isolated environment**:
   ```bash
   rm -rf genesis-phase{N}/
   ```

**Why this matters**: Catches integration issues **per-phase** (low cost) instead of bulk at the end (high token burn).

### **Stage 3: CONSOLIDATION** (After ALL 4 Phases)

Only after all 4 Stages are individually integrated:

1. **Run full Genesis test suite**:
   ```bash
   cd __tests__/genesis && npx jest
   ```
   - Target: 100% of Part IV tests passing

2. **Consolidate SQL migrations**:
   - Combine all phase schemas into one migration file
   - Test migration against remote Supabase
   - Verify RLS policies work

3. **Final verification**:
   - Main codebase tests: 100%
   - Genesis tests: 100%
   - Zero linter errors
   - TypeScript compilation clean

4. **Update plan document**:
   - Mark Part IV as 100% complete
   - Add Version changelog with metrics
   - Document total test count, coverage, integration details

---

## EXECUTION CHECKLIST (Use for EACH Phase)

### ‚úÖ **ISOLATED DEVELOPMENT**
- [ ] Created `genesis-phase{N}/` directory
- [ ] Implemented all phase functionality
- [ ] Written 60+ comprehensive tests
- [ ] All tests passing in isolation
- [ ] Coverage ‚â•85% statements, ‚â•80% branches
- [ ] Zero linter errors
- [ ] Phase documented in plan

### ‚úÖ **INCREMENTAL INTEGRATION** (NEW)
- [ ] Code copied to `lib/genesis/phase{N}/`
- [ ] Tests copied to `__tests__/genesis/phase{N}/`
- [ ] `lib/genesis/index.ts` exports updated
- [ ] TypeScript compilation verified (no errors)
- [ ] Test imports updated to `@/lib/genesis/...`
- [ ] Tests passing from integrated location
- [ ] Main codebase tests still 100%
- [ ] Isolated environment deleted

### ‚úÖ **PHASE COMPLETE**
- [ ] Phase marked complete in plan
- [ ] Metrics documented (test count, coverage)
- [ ] Ready for next phase

---

## CRITICAL RULES (READ BEFORE EVERY ACTION)

1. **ONE PHASE AT A TIME**: Never implement multiple phases simultaneously
2. **INCREMENTAL INTEGRATION**: Test each phase's integration before moving to next
3. **NO BULK FIXES**: If integration breaks, fix immediately, don't accumulate
4. **DOCUMENTATION DISCIPLINE**: Only update `GENESIS_SINGULARITY_PLAN_V35.md`
5. **TEST FROM INTEGRATED LOCATION**: Always verify tests pass after moving code
6. **VERIFY NO REGRESSIONS**: Main codebase must stay at 100% after every integration

---

## THE INTEGRATION TEST CONFIGURATION

Create `__tests__/genesis/jest.config.js` at the start (don't wait until integration):

```javascript
/** @type {import('jest').Config} */
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>'],
  testMatch: ['**/__tests__/genesis/**/*.test.ts'],
  moduleNameMapper: {
    '^@/lib/genesis/(.*)$': '<rootDir>/../../lib/genesis/$1',
    '^@/lib/(.*)$': '<rootDir>/../../lib/$1',
  },
  collectCoverageFrom: [
    '../../lib/genesis/**/*.ts',
    '!../../lib/genesis/**/*.d.ts',
    '!../../lib/genesis/index.ts',
  ],
  transform: {
    '^.+\\.(ts|js|mjs)$': ['ts-jest', {
      tsconfig: {
        esModuleInterop: true,
        moduleResolution: 'node',
      },
    }],
  },
  transformIgnorePatterns: [
    'node_modules/(?!(uuid)/)',
  ],
  verbose: true,
};
```

Also create `__tests__/genesis/babel.config.js`:

```javascript
module.exports = {
  presets: [
    ['@babel/preset-env', { targets: { node: 'current' } }],
    '@babel/preset-typescript',
  ],
};
```

---

## EXAMPLE: PHASE 43 EXECUTION FLOW

### **Step 1: Isolated Development**
```bash
# Create isolated environment
mkdir -p genesis-phase43/{lib,__tests__,sql}
cd genesis-phase43

# Implement State Reconciliation Watchdog per plan spec
# Write 60+ tests
# Verify: npm test (all pass), coverage (‚â•85%)

# Update plan: Mark Phase 43 as ‚úÖ DONE
```

### **Step 2: Incremental Integration** (NEW)
```bash
# Copy to main codebase
cp -r lib/* ../lib/genesis/phase43/
cp -r __tests__/* ../__tests__/genesis/phase43/

# Update lib/genesis/index.ts
# Add: export * from './phase43/reconciliation-watchdog';

# Verify TypeScript
cd ../lib/genesis && npx tsc --noEmit index.ts

# Fix test imports
cd ../../__tests__/genesis/phase43
# Change all "from '../lib/..." to "from '@/lib/genesis/..."

# Test from integrated location
cd ../__tests__/genesis && npx jest phase43/
# MUST pass all tests

# Verify main codebase
cd ../.. && npm test
# MUST stay at 100%

# Delete isolated environment
rm -rf genesis-phase43/
```

### **Step 3: Move to Phase 54**
Repeat Step 1 and Step 2 for Phase 54, then 55, then 56.

### **Step 4: Consolidation** (After all 4 phases)
```bash
# Run full Genesis suite
cd __tests__/genesis && npx jest

# Consolidate SQL
cat lib/genesis/phase43/schema.sql \
    lib/genesis/phase54/schema.sql \
    lib/genesis/phase55/schema.sql \
    lib/genesis/phase56/schema.sql \
    > supabase/migrations/20260127_part4_complete.sql

# Migrate to Supabase
# Update plan: Mark Part IV as 100% complete
```

---

## SUCCESS CRITERIA FOR PART IV

- [ ] All 4 phases (43, 54, 55, 56) implemented
- [ ] Minimum 240 tests total (60+ per phase)
- [ ] 100% of Part IV tests passing
- [ ] Main codebase tests remain at 100%
- [ ] All code in `lib/genesis/`
- [ ] All tests in `__tests__/genesis/`
- [ ] SQL schemas consolidated and migrated
- [ ] Part IV marked 100% complete in plan
- [ ] Zero linter errors
- [ ] Zero breaking changes

---

## ABORT CONDITIONS

**STOP and ask for user guidance if:**
1. Any phase integration causes main codebase tests to fail
2. You cannot fix integration issue within 3 attempts
3. TypeScript compilation errors persist after export fixes
4. You find yourself creating summary documents (violates Law #4)
5. You're implementing multiple phases simultaneously (violates Law #1)

---

## FINAL REMINDER

Read `.cursor/.EXECUTION_PHILOSOPHY.md` before starting.

**The refined workflow exists because**:
- Part III integration had 9 failing test suites at bulk integration
- Fixing bulk integration issues burned significant tokens
- Per-phase integration catches issues early (low cost)
- Incremental verification prevents accumulation of problems

**Quality over speed. One phase at a time. Test after every integration.**

---

**COMPLETED PHASES:**
- Phase 44: "God Mode" Command & Control (2026-02-08, branch: phase-44-god-mode, 59 tests, 17 files)

**NEXT**: Phase 45 (Sandbox & Simulation Engine)
