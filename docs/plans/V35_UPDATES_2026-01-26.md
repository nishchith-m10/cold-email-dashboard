# V35 Plan Updates - January 26, 2026

## Summary

Added four critical architectural sections to address "Physics Risks" and deployment reality gaps identified in the external V35 analysis.

---

## üÜï NEW ADDITIONS

### 1. **Section 3.5: Ohio Firewall Enforcement**
**Location:** After Section 3.4 (line ~406)

**Purpose:** Code-level protection against accidental mixing of Ohio legacy logic with V35 Sovereign logic

**Key Features:**
- Runtime firewall functions (`assertIsOhio`, `assertIsNotOhio`)
- Hard-fail on violation to prevent silent corruption
- `getLeadsTable()` helper for safe table name resolution
- Deployment checklist for firewall insertion points
- Monitoring and alerting for violations

**Why Critical:**
Without this, developers can accidentally call legacy n8n APIs for V35 tenants or query `leads_ohio` for non-Ohio workspaces, causing production corruption.

---

### 2. **Phase 53.4: Workflow Validation Layer**
**Location:** After Phase 53.1.3 (line ~3384)

**Purpose:** Schema drift protection for n8n workflow deployments

**Key Features:**
- Zod-based JSON schema validation for n8n workflows
- Golden Template Requirements enforcement
- Required/forbidden node type checks
- Credential reference validation
- Connection integrity verification
- Pre-Flight Check UI in God Mode dashboard
- Integration with Phase 68 (Fleet Updates)

**Why Critical:**
Without this, a single malformed workflow JSON could break n8n for thousands of tenants during a fleet update, requiring emergency rollback.

---

### 3. **Phase 55.2: Staggered Wake Protocol**
**Location:** After Phase 55.1.4 (line ~4401)

**Purpose:** Anti-Thundering Herd protection for mass hibernation wake events

**Key Features:**
- Staggered wake algorithm (1 req/sec to respect DO API limits)
- Priority-based wake ordering (Enterprise ‚Üí High ‚Üí Standard)
- Predictive wake scheduler (cron job analyzes upcoming campaigns)
- Staggered Wake Monitoring Dashboard
- Emergency Override with risk disclosure

**Why Critical:**
Without this, 5,000+ simultaneous wake requests (e.g., Monday 9 AM campaigns) would exceed DigitalOcean API rate limits, causing delays, bans, and angry users.

---

### 4. **Phase 69: Control Plane Deployment Architecture** ‚ö†Ô∏è MOST CRITICAL
**Location:** After Phase 68 (line ~12253)

**Purpose:** Clarifies the Vercel vs. dedicated server split for long-running services

**Key Features:**
- **The Reality:** Vercel cannot run BullMQ workers, Watchdog, Concurrency Governor
- Hybrid architecture: Vercel (frontend/API) + Railway/AWS (Control Plane)
- Deployment option comparison (Railway, Render, DO App, AWS ECS)
- Staged rollout (MVP ‚Üí Growth ‚Üí Scale ‚Üí Hyper-Scale)
- Complete Control Plane service code structure
- Monorepo structure (`control-plane/` directory)
- Cost estimates per stage ($50 ‚Üí $500 ‚Üí $3000/month)

**Why MOST Critical:**
**This is NOT optional.** The V35 architecture CANNOT run on Vercel alone. Without understanding this, you will:
- Build features that cannot deploy (BullMQ workers won't run)
- Experience production failures (Watchdog not polling, Sidecars timing out)
- Waste months trying to "make Vercel work" before realizing dedicated servers are required

**Answer to Your Question:**
You asked: *"Do I need to transition to AWS?"*

**Answer:** Not immediately AWS, but YES you need dedicated servers:
- **Stage 2 (100-1k tenants):** Vercel + Railway (~$50/month) ‚úÖ Start here
- **Stage 3 (1k-5k tenants):** Vercel + AWS ECS (~$200-500/month)
- **Stage 4 (5k-15k tenants):** Full AWS (~$1,000-3,000/month)

**Vercel alone is NOT an option for V35.** The Control Plane services (BullMQ, Watchdog, Heartbeat Processor) MUST run on dedicated servers from Day 1 of Sovereign Droplet deployment.

---

## üìä IMPACT ANALYSIS

### Addressed "Physics Risks" from External Analysis:

| Risk | Addressed By | Status |
|------|-------------|--------|
| **Ohio Code Infection** | Section 3.5: Ohio Firewall Enforcement | ‚úÖ Solved |
| **Bad Workflow Propagation** | Phase 53.4: Workflow Validation Layer | ‚úÖ Solved |
| **Simultaneous Wake Thundering Herd** | Phase 55.2: Staggered Wake Protocol | ‚úÖ Solved |
| **Vercel Cannot Run Control Plane** | Phase 69: Control Plane Architecture | ‚úÖ Clarified |

### Addressed "Critical Action Items":

| Action | Addressed By | Status |
|--------|-------------|--------|
| Pre-Warming needs more detail | Phase 55.1.4 already exists (Hot Standby Pool) | ‚úÖ Existing |
| Workflow validation missing | Phase 53.4: Workflow Validation Layer | ‚úÖ Added |
| Ohio firewall needed | Section 3.5: Ohio Firewall Enforcement | ‚úÖ Added |
| Staggered wake needed | Phase 55.2: Staggered Wake Protocol | ‚úÖ Added |
| Deployment architecture unclear | Phase 69: Control Plane Architecture | ‚úÖ Added |

---

## üéØ NEXT STEPS FOR IMPLEMENTATION

### Immediate (Before First Sovereign Droplet):
1. **Set up Railway account** (~$5 initial credit)
2. **Create `control-plane/` directory** in monorepo
3. **Deploy minimal Control Plane** (BullMQ worker only)
4. **Test Sidecar ‚Üí BullMQ ‚Üí Control Plane flow**

### Before 100 Tenants:
5. **Implement Ohio Firewall** in all legacy code paths
6. **Add Workflow Validation** to God Mode UI
7. **Deploy Watchdog service** to Control Plane

### Before 1,000 Tenants:
8. **Implement Staggered Wake** scheduler
9. **Upgrade to Railway Pro** or migrate to AWS ECS
10. **Add monitoring** (Datadog/New Relic)

---

## üìù DOCUMENT STATUS

- **V35 Plan Version:** V35.0
- **Last Updated:** 2026-01-26
- **Lines Added:** ~800+ lines of detailed architecture
- **New Phases:** 1 (Phase 69)
- **New Sub-Sections:** 3 (Section 3.5, Phase 53.4, Phase 55.2)
- **Total Document Size:** 23,375+ lines ‚Üí 24,200+ lines

---

## ‚úÖ VALIDATION

All points from the external analysis have been addressed:

### "3 Non-Obvious 'Physics' Risks":
1. ‚úÖ **Ohio Code Infection** ‚Üí Section 3.5 adds runtime firewalls
2. ‚úÖ **Bad Workflow Propagation** ‚Üí Phase 53.4 adds validation layer
3. ‚úÖ **Thundering Herd on Wake** ‚Üí Phase 55.2 adds stagger algorithm

### "5 Critical Action Items":
1. ‚úÖ **Pre-Warming Detail** ‚Üí Already exists in Phase 55.1.4
2. ‚úÖ **Workflow Validation** ‚Üí Phase 53.4 added
3. ‚úÖ **Ohio Firewall** ‚Üí Section 3.5 added
4. ‚úÖ **Staggered Wake** ‚Üí Phase 55.2 added
5. ‚úÖ **Deployment Architecture** ‚Üí Phase 69 added (MOST CRITICAL)

**Analysis Accuracy:** 100% - All identified gaps were real and have been addressed.

---

## üö® CRITICAL TAKEAWAY

**Phase 69 is the most important addition.** It reveals that:
- V35 CANNOT run on Vercel alone
- Control Plane services MUST run on Railway/AWS/Render
- This requirement exists from Day 1 of Sovereign Droplet deployment
- Budget: +$50-100/month for Railway (Stage 2) ‚Üí +$200-500/month for AWS ECS (Stage 3)

**Without understanding this, the entire V35 architecture cannot be implemented.**
