# üß† Cold Email Dashboard - Project Context (The "Magna Carta")

> **This contains the complete architectural DNA of the system.**

---

## üìç Quick Start Message

ACT AS: Distinguished Systems Architect (L10) & Technical Lead.
CURRENT STATE: Phase 27 (Sequences / Dispatch Monitor).

PROJECT: High-Frequency Cold Email Orchestration Engine.

STACK: Next.js 14 (App Router), Supabase (PostgreSQL), n8n (Automation), Clerk (Auth).

REPO: https://github.com/nishchith-m1015/cold-email-dashboard

URL: https://cold-email-dashboard.vercel.app

STATUS:
COMPLETED: Phases 1-26 (Foundation, Analytics, Multi-Tenancy, Leads CRM).

ACTIVE: Phase 27 "Sequences" (Draft Viewer & Schema Sync).

NEXT: Phase 28 "Golden 10" (Intelligence & Scoring).

CRITICAL CONTEXT:
Hybrid Architecture: Logic is split between Code (Next.js) and Low-Code (n8n).

Source of Truth: The leads_ohio table is the master lead record (NOT contacts).

Performance: Uses Materialized Views (mv_daily_stats) for sub-50ms analytics.
Read docs/PROJECT_CONTEXT.md for the full forensic audit.

---

## üéØ System Architecture: The "Hybrid Engine"

**What is this?**
This is not a CRUD app. It is a **Distributed Control Plane** for an automated agency. It orchestrates thousands of cold emails, tracks financial attribution per-token, and provides real-time intelligence.

**The 4 Architectural Pillars:**
1.  **Hybrid Nervous System:**
    * **The Brain (n8n):** Handles business logic, research, decision making, and email sending.
    * **The Body (Next.js + Supabase):** Handles state, user interface, analytics aggregation, and auth.
2.  **Strict Multi-Tenancy:**
    * Data is isolated at the Row Level (RLS) using `workspace_id`.
    * Users interact via `user_workspaces` (Role-Based Access).
3.  **Zero-Latency Analytics:**
    * We do **not** query raw logs for the dashboard.
    * We use **Materialized Views** (`mv_daily_stats`) and RPC functions (`refresh_dashboard_views`) to serve pre-calculated metrics in <50ms.
4.  **Financial Forensics:**
    * Every API call (OpenAI, Relevance, etc.) is logged to `llm_usage`.
    * Costs are attributed to specific `campaign_name` and `run_id` for exact unit economics.

---

## ‚úÖ Detailed Phase History

### üü¢ Phases 1-6: The MVP & Tracking Core
* **Email Tracking:** Implemented pixel-based Open Tracking (`/api/track/open`) and Redirect Click Tracking (`/api/track/click`).
* **Cost Tracking:** Built the `llm_usage` table to capture token usage from n8n via Webhooks.
* **Deployment:** Vercel + Supabase production environment established.

### üü¢ Phases 7-15: The "Enterprise" Pivot
* **Migration:** Moved from Google Sheets to **Supabase PostgreSQL** as the primary DB.
* **Auth Integration:** Replaced custom auth with **Clerk**.
    * *Middleware:* `middleware.ts` protects routes and syncs Clerk user IDs.
    * *Webhooks:* `/api/webhooks/clerk` syncs user creation to the DB.
* **RLS Implementation:** Applied Row Level Security policies to `contacts`, `email_events`, and `llm_usage` to enforce owner-only access.

### üü¢ Phases 16-20: Multi-Tenancy Deep Dive
* **Workspace Architecture:** Created `workspaces` and `user_workspaces` tables.
* **Invite System:** Built the logic for inviting members via email (`/api/workspaces/[id]/invites`).
* **Context Switching:** Built the `WorkspaceProvider` and UI Switcher to instantly toggle data contexts without reloading the page.

### üü¢ Phases 21-25: The Performance Engine
* **Materialized Views:** Created `mv_daily_stats` to cache expensive `COUNT(*)` queries on millions of events.
* **Idempotency:** Implemented the `webhook_queue` table and triggers.
    * *Logic:* n8n sends a webhook -> DB stores in Queue -> Trigger processes it -> Deduplication ensures exactly-once execution.
* **Hyper-Speed UX:**
    * **Prefetching:** Hovering over nav links triggers SWR `mutate`.
    * **Global Search:** `Command+K` palette for instant navigation.

### üü¢ Phase 26: Leads Command Center (CRM)
* **The Master Grid:** Built `app/contacts/page.tsx` using TanStack Table (Headless).
* **Server-Side Pagination:** implemented cursor-based pagination (50 rows/load) for infinite scroll.
* **Schema Reality Check:** Confirmed `leads_ohio` is the active table.
* **UX Refinements:**
    * **Slide-Over Inspector:** Clicking a row opens a details sheet (not a new page).
    * **Industry Coloring:** Visual badges for industries (Construction=Yellow, etc.).
    * **Sorting:** Fixed default sort to `ORDER BY id ASC`.

---

## üöß Active Development

### üü° Phase 27: "Sequences" (Dispatch Monitor)
**Goal:** A "Control Tower" to view the HTML email drafts generated by n8n before they are sent.

**Architecture:**
1.  **Schema Sync:**
    * Target Table: `leads_ohio`.
    * Target Columns: `email_1_subject`, `email_1_body` (HTML), `email_2_body`, `email_3_subject`, `email_3_body`.
2.  **API Strategy (Split for Speed):**
    * `GET /api/sequences`: Fetches lightweight list (ID, Name, Status) for the sidebar.
    * `GET /api/sequences/[id]`: Fetches the heavy HTML body content on demand.
3.  **Security:**
    * **Sanitization:** Implementing `lib/html-sanitizer.ts` (DOMPurify) to safely render the `<br>` tags without XSS risks.
4.  **UI Components:**
    * `SequenceDeck`: A 3-column view of the email timeline.
    * **"Hey ," Detector:** Red warning badge if the name variable is missing in the draft.

---

## üîÆ Future Roadmap (The Golden Path)

### Phase 28: Golden 10 Intelligence (Scoring)
* **Goal:** Turn the static list into a scored leaderboard.
* **Implementation:**
    * Add `lead_score` (0-100) and `reply_sentiment` columns to `leads_ohio`.
    * Build n8n workflow to calculate score based on Title/Industry/Company Size.
    * Display Score Badges (Green/Yellow/Red) in the CRM.

### Phase 29: The "Agentic" Feedback Loop
* **Goal:** Human-in-the-Loop correction.
* **Feature:** A "Reject/Edit" button in the **Sequences** view.
* **Logic:** Clicking "Reject" fires a webhook to n8n to pause the sequence and log the error for the AI to learn.

### Phase 30: "God Mode" (Campaign Orchestration)
* **Goal:** Control n8n from Next.js.
* **Feature:** Start/Stop/Pause buttons for campaigns directly in the dashboard.
* **Tech:** Uses n8n API to toggle workflow activation states.

---

## üóÑÔ∏è Database Schema & Forensics

### Key Tables
| Table | Description | Key Columns |
| :--- | :--- | :--- |
| **`leads_ohio`** | **Master Lead Record**. | `id`, `email_address`, `full_name`, `status`, `email_1_body`... |
| **`email_events`** | **The Timeline**. Logs every interaction. | `event_type` (sent, opened), `campaign_name`, `provider_message_id`. |
| **`llm_usage`** | **Financial Ledger**. | `cost_usd`, `tokens_in`, `tokens_out`, `provider` (OpenAI/Anthropic). |
| **`mv_daily_stats`** | **Performance View**. | `day`, `campaign_name`, `sends`, `replies` (Aggregated). |
| **`webhook_queue`** | **Ingestion Buffer**. | `idempotency_key`, `payload`, `processed` (Boolean). |

### Important Triggers
* **`trigger_update_daily_stats`**: Fires on `INSERT` to `email_events`. Updates the Materialized View incrementally.
* **`process_webhook_queue`**: Fires on `INSERT` to `webhook_queue`. Routes data to the correct destination tables.

---

## üìù n8n Integration Logic

**The "Brain" (n8n) connects to the "Body" (App) via:**

1.  **Ingestion Webhook:**
    * **URL:** `https://cold-email-dashboard.vercel.app/api/events`
    * **Header:** `x-webhook-secret: [ENV_VAR]`
    * **Payload:** `{ type: 'sent', email: '...', cost: 0.002, metadata: {...} }`

2.  **Dispatch Webhook (New in Phase 27):**
    * **URL:** `https://cold-email-dashboard.vercel.app/api/hooks/draft-created`
    * **Action:** Updates `leads_ohio` with the generated HTML body.

---

## üîê Environment Variables

```bash
# App & Auth
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Database
NEXT_PUBLIC_SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=ey... (Required for Admin actions)

# Security
N8N_WEBHOOK_SECRET=... (Must match n8n Header)
DASH_WEBHOOK_TOKEN=... (Legacy)

# Feature Flags
NEXT_PUBLIC_ENABLE_SEQUENCES=true



Last Updated: December 13, 2025
Maintained By: System Architect (Plan Mode)
